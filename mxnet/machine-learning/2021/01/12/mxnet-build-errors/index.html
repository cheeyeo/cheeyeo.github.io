<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Building / Compiling MXNet errors &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Common errors encountered with building MxNet">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="mxnet, machine-learning">
    <link rel="canonical" href="https://www.cheeyeo.dev/mxnet/machine-learning/2021/01/12/mxnet-build-errors/">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Lato:900,300|Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/assets/global-ef3d2a30bafae51bdca9401db921816a.css" type="text/css">

    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <script src="/assets/modernizr.custom-d69c837039e5f58032e4842950ab13c3.js" async></script>

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Building / Compiling MXNet errors">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="/mxnet/machine-learning/2021/01/12/mxnet-build-errors/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Building / Compiling MXNet errors</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">January 12, 2021</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/mxnet">mxnet</a>
      </li>
      
      <li>
        <a href="/categories/machine-learning">machine-learning</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p>MXNet is a popular machine learning / deep learning framework. Compared to its peers such as TensorFlow, it is not as popular.</p>

<p>Indeed, my last search on safari books online only yielded publications with the <code class="language-plaintext highlighter-rouge">mxnet</code> name mentioned but no concrete examples on how to build or use it.</p>

<p>In this post I aim to show some of the common errors I encountered while building it manually. In future posts, I will demonstrate how I build it from scratch using multi-stage builds.</p>

<p>Below is a list of such errors I encountered.</p>

<p>Please note that its not meant to be a comprehensive / exhaustive list and as usual, different system setup and requirements may / may not result in different errors than mine.</p>

<h3 id="compilation-failures">Compilation Failures</h3>

<p>In my earlier attempts at compilation, the process would fail suddenly with errors such as:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="c">...
</span><span class="go">c++: internal compiler error: Killed (program cc1plus)
Please submit a full bug report,
with preprocessed source if appropriate.
</span><span class="gp">See &lt;file:///usr/share/doc/gcc-7/README.Bugs&gt;</span><span class="w"> </span><span class="k">for </span>instructions.
<span class="go">make[2]: *** [CMakeFiles/mxnet_static.dir/src/operator/tensor/indexing_op.cc.o] Error 4
make[2]: *** Waiting for unfinished jobs....
</span><span class="c">...</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This is related to a <a href="https://github.com/apache/incubator-mxnet/issues/13773" target="_blank">gcc 7.5 memory leak issue</a></p>

<p>Assuming you have gcc 8 installed, we can use gcc 8 by passing in the following options during compilation…</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="go">export CC="gcc-8" &amp;&amp; \
export CXX="g++-8"</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Examples show compilation through <code class="language-plaintext highlighter-rouge">ninja</code> build tool. However, my attempts at using it have been unsuccessful. I find that at least on my local machine, <code class="language-plaintext highlighter-rouge">ninja</code> tends to consume more CPU and memory resources than it should whereas with <code class="language-plaintext highlighter-rouge">cmake</code> build tool, I have more control over the number of processes and it also shows the logs in the console than using the former.</p>

<h3 id="onnx-issues">ONNX Issues</h3>

<p>If compilation fails with <code class="language-plaintext highlighter-rouge">namespace not found</code> with onnx option set, then set the appropriate environment variable:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="go">export ONNX_NAMESPACE=onnx</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>After compilation but while loading the framework, if it fails with <code class="language-plaintext highlighter-rouge">File already exists: ... onnx-ml.proto</code>, this is due to the <code class="language-plaintext highlighter-rouge">protobuf</code> library being built as a shared library and since <code class="language-plaintext highlighter-rouge">onnx-ml.proto</code> is also symlinked by other libs, it will raise an error.</p>

<p>The only solution to this is to remove all previous installs of protobuf and build it again manually. The below works for me:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="go">git clone --recursive -b 3.5.1.1 https://github.com/google/protobuf.git &amp;&amp; \
    cd protobuf &amp;&amp; \
    ./autogen.sh &amp;&amp; \
    ./configure --disable-shared CXXFLAGS=-fPIC --prefix=/protobufbuild &amp;&amp; \
    make -j4 &amp;&amp; \
    make install &amp;&amp; \
    ldconfig &amp;&amp; \
    cd / &amp;&amp; \
    cp /protobufbuild /usr/local &amp;&amp; \
    rm -rf protobuf</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Note the <code class="language-plaintext highlighter-rouge">--disable-shared</code> option which builds it as a static library.</p>

<p>For running onnx in python, we need to install the <code class="language-plaintext highlighter-rouge">onnx</code> pypi package. A compatible version I found to work across all mxnet versions from v1.6.x - v1.8.x is <code class="language-plaintext highlighter-rouge">onnx==1.3.0</code></p>

<h3 id="mkldnn-issues">MKLDNN Issues</h3>

<p>MKLDNN is the intel graphics driver for running ML operations on Intel-compatible CPUs. It’s a suitable replacement for NVIDIA gpus. More information on <a href="https://mxnet.apache.org/versions/1.7.0/api/python/docs/tutorials/performance/backend/mkldnn/mkldnn_readme.html" target="_blank">Intel MKLDNN</a></p>

<p>The errors below only apply for me when I was trying to compile a python wheel of mxnet. It may not be applicable in your use case.</p>

<p>While compiling the python wheel, I had to enable TVM and it threw an error of:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="go">Traceback (most recent call last):
</span><span class="gp">    File "/mxnet/contrib/tvmop/compile.py", line 20, in &lt;module&gt;</span><span class="w">
</span><span class="go">      import tvm
</span><span class="gp">    File "/mxnet/3rdparty/tvm/python/tvm/__init__.py", line 36, in &lt;module&gt;</span><span class="w">
</span><span class="go">      from . import target
</span><span class="gp">    File "/mxnet/3rdparty/tvm/python/tvm/target.py", line 70, in &lt;module&gt;</span><span class="w">
</span><span class="go">      raise err_msg
</span><span class="gp">    File "/mxnet/3rdparty/tvm/python/tvm/target.py", line 66, in &lt;module&gt;</span><span class="w">
</span><span class="go">      from decorator import decorate
  ModuleNotFoundError: No module named 'decorator'</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Ensure that the <code class="language-plaintext highlighter-rouge">decorator==4.4.2</code> pypi package is present before building the 3rd party plugins.</p>

<p>Another issue I encountered was <a href="https://github.com/apache/incubator-mxnet/issues/16704" target="_blank">not being able to locate / load the TVM config file issue</a></p>

<p>After building mxnet, you need to run the following to copy the generated <code class="language-plaintext highlighter-rouge">tvmop.conf</code> file from the build folder into <code class="language-plaintext highlighter-rouge">/usr/local/lib/&lt;python version&gt;/lib</code>:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="go">mkdir -p /usr/local/lib/python3.6/lib &amp;&amp; \
cp tvmop.conf /usr/local/lib/python3.6/lib/</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="cuda-versions">CUDA versions</h3>

<p>Another point to note is that for v1.8.x and above, it uses cuda version 10.2 and above. If you are building multiple versions of MXNet in Docker your Dockerfile would need to take into account the different versions required else compilation will not work.</p>

<h3 id="conclusion">Conclusion</h3>

<p>In conclusion, it takes some effort to get MXNet to compile from source but you will learn a lot about the framework just by doing it - I certainly did.</p>

<p>Happy Hacking.</p>


</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="https://www.cheeyeo.dev/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:f/mnqwaypk"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2022 Chee Yeo<br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>




  

  <script src="/assets/site.min-fc110d15723a68aba602939bc68958f7.js" type="text/javascript" async></script>
</body>
</html>
