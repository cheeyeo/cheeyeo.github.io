---
layout: post
show_meta: true
title: Using uv with Docker to package applications
header: Using uv with Docker to package applications
date: 2025-11-02 00:00:00
summary: How to use uv with Docker to package and deploy applications
categories: python uv docker
author: Chee Yeo
---

[uv and docker integration guide]: https://docs.astral.sh/uv/guides/integration/docker
[uv docker example project]: https://github.com/astral-sh/uv-docker-example

In a previous post, I wrote about how to use `uv` to manage a python project dependencies. Once that is setup, we also need to extend `uv` to use it in docker image builds and CI/CD pipelines too.

The official [uv and docker integration guide] provides information and a [uv docker example project] to show how it can be done. Firstly, I modified the dockerfile to support multi-stage builds. This is the recommended approach to creating smaller image sizes as the deps are installed in a temp image and copied across in the final stage. The first stage or `builder` stage uses the `uv` image to install the deps. The final stage uses a python image and copies the project and deps across.

The dockerfile for the builder is provided below:
```
FROM ghcr.io/astral-sh/uv:trixie-slim AS builder

# SET ENV
ENV SHELL=/bin/bash
ENV LIBRARY_PATH=/lib:/usr/lib
ENV UV_PYTHON_INSTALL_DIR=/opt/uv/python
# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1

WORKDIR /app
COPY pyproject.toml uv.lock .
RUN uv venv --relocatable --python 3.13.8 && uv sync --locked --no-dev --no-install-project
COPY . /app
RUN source .venv/bin/activate && uv sync --locked --no-dev
````

We used the official docker image as the builder. We set the `UV_COMPILE_BYTECODE` parameter to speed up compilation of python modules. We also set the `UV_PYTHON_INSTALL_DIR` to a fixed location so we can reference it later. Next, we copy the project directory, which includes the pyproject.toml and uv.lock files. As per the guide, we create a venv with the desired python version and then install only the project deps first. Finally, we activate the venv and call sync again to install the project,



The second stage copies the artifacts from the first image. The dockerfile:
```
FROM python:3.13.8-slim-trixie AS runner
SHELL [ "/bin/bash", "-c" ]

ENV SHELL=/bin/bash
ENV PYTHONBUFFERED=1
ENV FLASK_APP=application.py
ENV LIBRARY_PATH=/lib:/usr/lib
ENV VIRTUAL_ENV=/app/.venv
ENV PATH="/app/.venv/bin:$PATH"

# Creates non-root user
RUN groupadd --system --gid 1000 appuser \ 
  && useradd --system -ms /bin/bash --gid 1000 --uid 1000 --create-home appuser \
  && usermod -aG sudo appuser \
  && mkdir -p /app && mkdir -p /app/logs \
  && chown -R appuser:appuser /app \
  && chown -R appuser:appuser /app/logs

WORKDIR /app

# Copy files from builder
COPY --from=builder --chown=appuser:appuser  /opt/uv/python /opt/uv/python
COPY --from=builder --chown=appuser:appuser /app /app

EXPOSE 5000

USER appuser
ENTRYPOINT ["/app/boot.sh"]
```

We set the env var `VIRTUAL_ENV` to point at the directory of the application's venv created earlier. We add the venv path directory to the system PATH var.

We create a non-root user to run the applications, copies from the `builder` image the venv and application code. 

To support running the application in docker compose, we need to register new watches on changes to `uv.lock` and `pyproject.toml` which would trigger a container rebuild. We also need to ignore the `.venv` directory:
```
...

    develop:
      watch:
        - action: sync
          path: ./board
          target: /app/board
          ignore:
            - __pycache__
            - .venv/
        - action: rebuild
          path: uv.lock
        - action: rebuild
          path: pyproject.toml
        - action: rebuild
          path: ./migrations
```

Within github pipeline, we can use the `astral-sh/setup-uv@v7` action to install specific version of uv and then use it in subsequent actions:
```
 - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          # Install a specific version of uv.
          version: "0.9.0"

 - name: Setup python
   uses: actions/setup-python@v5
   with:
     python-version-file: ".python-version"

- name: Install project
  run: |
    uv sync --locked

```

With this approach, I managed to use uv for both development and deployment....