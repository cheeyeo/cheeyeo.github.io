<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Setting up SSL with Jekyll using LetsEncrypt &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Using LetsEncrypt to generate SSL certs for use with a Jekyll blog.">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="letsencrypt, ruby, jekyll, ssl">
    <link rel="canonical" href="http://localhost:4000/letsencrypt/ruby/jekyll/ssl/2016/02/07/setting_up_ssl_with_jekyll_and_lets_encrypt/">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Lato:900,300|Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/assets/global-ef3d2a30bafae51bdca9401db921816a.css" type="text/css">

    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <script src="/assets/modernizr.custom-d69c837039e5f58032e4842950ab13c3.js" async></script>

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Setting up SSL with Jekyll using LetsEncrypt">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="http://localhost:4000/letsencrypt/ruby/jekyll/ssl/2016/02/07/setting_up_ssl_with_jekyll_and_lets_encrypt/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Setting up SSL with Jekyll using LetsEncrypt</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">February 7, 2016</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/letsencrypt">letsencrypt</a>
      </li>
      
      <li>
        <a href="/categories/ruby">ruby</a>
      </li>
      
      <li>
        <a href="/categories/jekyll">jekyll</a>
      </li>
      
      <li>
        <a href="/categories/ssl">ssl</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p><a href="https://letsencrypt.org/" target="_blank">LetsEncrypt</a> is a CA which allows you to register for free SSL certificates for use on your website. The following are the steps I took to register for a SSL certificate for my current website.</p>

<h2 id="step-1-getting-letsencrypt">Step 1: Getting letsencrypt</h2>
<p>The first step is to clone the letsencrypt repo from github. It includes the client which you will need to generate the certificates:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="go">cd letsencrypt

sudo ./letsencrypt-auto certonly -a manual --rsa-key-size 4096 -d mysite.com -d www.mysite.com</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The above command essentially reads to generate SSL for my domains cheeyeo.uk and www.cheeyeo.uk with a rsa key size of 4096. The certonly flag means to use only the “standalone” or “webroot” plugins to request for a certificate. The letsencrypt client can integrate with Apache and Nginx servers directly but that is outside the scope of the current article.</p>

<p>The sudo flag is required as it writes to certain system directories such as /etc/letsencrypt. Without it, I kept receiving python missing module errors and running as root seems to resolve it.</p>

<p>Once the above completes, you will be prompted with a screen asking you for permission to log your IP address.</p>

<p>Once confirmed, you will be presented with instructions on creating a specific url on your server that needs to return a nounce or token.</p>

<p>This is usually in the form of:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="go">Make sure your web server displays the following content at
http://www.yourdomain.com/.well-known/acme-challenge/weoEFKS-aasksdSKCKEIFIXCNKSKQwa3d35ds30_sDKIS before continuing:

weoEFKS-aasksdSKCKEIFIXCNKSKQwa3d35ds30_sDKIS.Rso39djaklj3sdlkjckxmsne3a
Content-Type header MUST be set to text/plain.</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>(The above is just an example and you will see a different output!)</p>

<p>For Jekyll, since we are serving static resources from the _site directory, this means that the folder will always be wiped on each deploy.</p>

<p>To workaround this, I added the <strong>keep_files</strong> directive to my _config.yml file:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="c1"># _config.yml</span>
<span class="s">....</span>

<span class="na">keep_files</span><span class="pi">:</span> <span class="pi">[</span>
  <span class="s1">'</span><span class="s">.well-known/acme-challenge'</span>
<span class="pi">]</span>

<span class="s">....</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Then we create the directories and the required file:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="go">cd _site/.well-known/acme-challenge

</span><span class="gp">echo -n "weoEFKS-aasksdSKCKEIFIXCNKSKQwa3d35ds30_sDKIS.Rso39djaklj3sdlkjckxmsne3a" &gt;</span><span class="w"> </span><span class="s2">"weoEFKS-aasksdSKCKEIFIXCNKSKQwa3d35ds30_sDKIS"</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Next, I added the <strong>_site/.well-known</strong> subdirectory into a git commit, ready to be pushed to the Heroku server. Once that is done, check that you can access it manuall by visiting the url above directly.</p>

<p>Please also note that you need to repeat the process above for each domain you listed in the -d flag. For example, I needed to do the deploy twice because I added 2 domains: ‘mysite.com’ and ‘www.mysite.com’.</p>

<p>Assuming you don’t run into any glitches, you have completed step 1 of the process.</p>

<p>Your certificates will be downloaded and stored on your local filesystem under <strong>/etc/letsencrypt/live/mysite.com</strong>. There should be 4 files namely: <strong>cert.pem; chain.pem; fullchain.pem; privkey.pem</strong></p>

<p>I copied them into my jekyll folder and gitignore it as we need them for step 2.</p>

<h2 id="step-2-setting-up-ssl-on-heroku">Step 2: Setting up SSL on Heroku</h2>

<p>You need to add the SSL addon to use SSL and add the certs from step 1:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="go">heroku addons:create ssl:endpoint

heroku certs:add ssl/cert.pem ssl/privkey.pem ssl/chain.pem ssl/fullchain.pem</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>To check that its all setup properly:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="go">heroku certs

heroku certs:info</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>If it all goes well, you should see a dedicated sslenpoint with an ending domain of <strong>herokussl.com</strong> which you need for step 3. Also, check that the heroku certs:info return <strong>Trusted</strong> field as <strong>True</strong> before proceeding further.</p>

<h2 id="step-3-configuring-dns">Step 3: Configuring DNS</h2>

<p>Next we need to update the CNAME record of your DNS settings to point to the new heroku ssl endpoint above. In my case it took several hours for the changes to propagate.</p>

<p>Once done you should see something like the following:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="go">host www.mysite.com

mysite.herokussl.com is an alias for xxxxxxxx</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>To check that the ssl is successfully deployed, run the following:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="go">curl -kvI www.mysite.com

</span><span class="gp">* Connected to www.mysite.com (XXXXXX) port 443 (#</span>0<span class="o">)</span>
<span class="go">* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate: mysite.com
* Server certificate: Let's Encrypt Authority X1
* Server certificate: DST Root CA X3</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="step-4-jekyll-and-heroku-specific-issues">Step 4: Jekyll and heroku specific issues</h2>

<p>The above setup works for me up until the point when I started getting Mixed content warnings in the chrome browser when visiting individual posts pages. Make sure that if you are using the <strong>site.baseurl</strong> call to generate the post url in _config.yml, update it to your full https version.</p>

<p>The other issue is redirection from non-ssl to ssl links. Since I’m only serving static pages using Rack, links to the non-ssl pages still renders the non-ssl versions of the site.</p>

<p>To fix this, I added a 301 permanent redirect from my DNS console.</p>

<p>That only managed to fix the issue of root request of <strong>mysite.com</strong> to be redirected to <strong>https://www.mysite.com</strong>. Calls to <strong>www.mysite.com</strong> still reaches the non-ssl version.</p>

<p>To fix this, I used the <a href="https://github.com/tobmatth/rack-ssl-enforcer" target="_blank">rack-ssl-enforcer</a> gem. By requiring it into the config.ru file and redeploying it, all requests for the root domain or non-ssl gets redirected to the ssl version of the site.</p>

<p>Other recommendations from other users with similar issues as mine include using an nginx buildpack to serve as a proxy but that seems a lot of work in my use case. Perhaps as another blog post in the future.</p>

<p>Success at last!</p>

<h2 id="conclusion">Conclusion</h2>

<p>LetsEncrypt is great and I would defintely suggest taking it for a test run. Note that the certificates are only valid for 3 months maximum. This is a security feature and you can <a href="https://letsencrypt.org/2015/11/09/why-90-days.html" target="_blank">read more about it here</a>.</p>

<p>For a more detailed read on setting it up on OS X, <a href="https://community.letsencrypt.org/t/tutorial-for-os-x-local-certificates-and-shared-hosting/6859" target="_blank">read about it here</a></p>

</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:f/mnqwaypk"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2022 Chee Yeo<br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>




  
    <script src="//localhost:35729/livereload.js" async></script>
  

  <script src="/assets/site.min-fc110d15723a68aba602939bc68958f7.js" type="text/javascript" async></script>
</body>
</html>
