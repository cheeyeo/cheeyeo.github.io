<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fixing thunderbolt3 on Ubuntu 18.04 LTS for eGPU &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Pain-free guide to fixing the issue of thunderbolt3 in Ubuntu 18.04">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="18.04, egpu, machine-learning, thunderbolt3, ubuntu">
    <link rel="canonical" href="https://www.cheeyeo.dev/machine-learning/thunderbolt3/egpu/ubuntu/18.04/2021/11/23/thunderbolt3-egpu-ubuntu/">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Lato:900,300|Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/assets/global-ef3d2a30bafae51bdca9401db921816a.css" type="text/css">

    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <script src="/assets/modernizr.custom-d69c837039e5f58032e4842950ab13c3.js" async></script>

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Fixing thunderbolt3 on Ubuntu 18.04 LTS for eGPU">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="/machine-learning/thunderbolt3/egpu/ubuntu/18.04/2021/11/23/thunderbolt3-egpu-ubuntu/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Fixing thunderbolt3 on Ubuntu 18.04 LTS for eGPU</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">November 23, 2021</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/18.04">18.04</a>
      </li>
      
      <li>
        <a href="/categories/egpu">egpu</a>
      </li>
      
      <li>
        <a href="/categories/machine-learning">machine-learning</a>
      </li>
      
      <li>
        <a href="/categories/thunderbolt3">thunderbolt3</a>
      </li>
      
      <li>
        <a href="/categories/ubuntu">ubuntu</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  
<p>On a previous post on using <a href="https://www.cheeyeo.dev/egpu/ubuntu/18.04/machine-learning/2020/03/13/multi-egpu-ubuntu/">eGPU for Machine Learning</a>, I described a process of setting up an external GPU for local distributed training of ML models.</p>

<p>It relies on using the <strong>bolt</strong> package provided upstream which is fixed at <strong>0.5.0</strong> for Ubuntu 18.04 LTS. </p>

<p>After a kernel update to version <strong>4.15.0-163-generic</strong>, the thunderbolt controller was put into a forced shutdown everytime the system starts, resulting in the thunderbolt3 controller not being able to recognise the eGPU.</p>

<p>After some digging, I discovered that the thunderbolt controller is running as a background service under systemctl. This means that we can stop this service and replace it with another one which calls an updated version of bolt.</p>

<p>I removed the system version and resinstalled a later version of boltd to test if this would fix the issue of the forced shutdown detailed above.</p>

<p>The process I took was as follows:</p>

<ul>
  <li>
    <p>Download the <a href="https://gitlab.freedesktop.org/bolt/bolt/-/releases">bolt source</a>. I picked version 0.7.0.</p>
  </li>
  <li>
    <p>Setup a venv through python as the build stage requires meson, a python package, for compilation.</p>
  </li>
</ul>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno">1</span> <span class="gp">#</span> make sure in virtual env and install meson and ninja 
<span class="lineno">2</span> <span class="go">python3 -m venv boltvenv</span>
<span class="lineno">3</span> <span class="go">source boltvenv/bin/activate</span>
<span class="lineno">4</span> <span class="go">pip install meson</span>
<span class="lineno">5</span> <span class="go">pip install ninja</span>
<span class="lineno">6</span> 
<span class="lineno">7</span> <span class="go">sudo apt-get install libpolkit-gobject-1-dev</span></code></pre></div>

<ul>
  <li>Compile bolt from source as follows:</li>
</ul>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno"> 1</span> <span class="go">curl -L https://gitlab.freedesktop.org/bolt/bolt/-/archive/0.7/bolt-0.7.tar.gz -o bolt.tar.gz</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="go">tar -zxvf bolt.tar.gz</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="go">cd bolt-0.7.0</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="go">meson build \</span>
<span class="lineno"> 8</span> <span class="go">      --sysconfdir=/etc \</span>
<span class="lineno"> 9</span> <span class="go">      --localstatedir=/var \</span>
<span class="lineno">10</span> <span class="go">      --sharedstatedir=/var/lib</span></code></pre></div>

<pre><code>Note that I left the build parameters as the defaults as documented on the project website.
</code></pre>

<ul>
  <li>Build the bolt package:</li>
</ul>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno">1</span> <span class="go">ninja -C build</span>
<span class="lineno">2</span> 
<span class="lineno">3</span> <span class="go">ninja -C build test</span>
<span class="lineno">4</span> 
<span class="lineno">5</span> <span class="go">sudo ninja -C build install</span>
<span class="lineno">6</span> 
<span class="lineno">7</span> <span class="go">sudo systemctl daemon-reload</span></code></pre></div>

<p>Restart the system.</p>

<p>If the above goes well, you should have the bolt service running after running <strong>sudo systemctl status bolt</strong></p>

<p><img src="/assets/img/egpu/bolt_systemctl.png" alt="Output of systemctl status for bolt" /></p>

<p>Running <strong>boltctl –version</strong> should also report version 0.7.0</p>

<p>Next check that the current device (laptop) is registered successfully as a domain under bolt via :</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno">1</span> <span class="go">boltctl domains</span></code></pre></div>

<p><img src="/assets/img/egpu/bolt_domains.png" alt="Output of boltctl domains" /></p>

<p>Connect the eGPU, reboot and check that its connected and registered with bolt:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno">1</span> <span class="go">boltctl list</span></code></pre></div>

<p><img src="/assets/img/egpu/bolt_list.png" alt="Output of boltctl list" /></p>

<p><img src="/assets/img/egpu/gnome_panel.png" alt="GNOME Panel view of thunderbolt" /></p>

<p>Note that the screenshots above show that the eGPU has been purposefully disconnected to ensure that the device has been successfully registered on system reboot. Using version 0.5.0 of bolt package, it was blank.</p>

<p>The screenshots also shows that it has managed to register the eGPU on reboot. The GNOME control panel has also displayed the registered eGPU which shows that the bolt service is running properly.</p>

<p>Note that you will need to plugin the eGPU and restart before <strong>nvidia-smi</strong> can recognise the additional GPU.</p>

<h3 id="further-notes">Further Notes</h3>

<p>If the eGPU is still not recognised you can check that the physical thunderbolt controller is actually enabled under the BIOS.</p>

<p>I ran the following command from the terminal since I can’t get into BIOS due to GRUB:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno">1</span> <span class="go">sudo systemctl reboot --firmware-setup</span></code></pre></div>

<p>Check for the presence of thunderbolt3 hardware controller and ensure its enabled.</p>

<p>As an additional measure, I also enabled the option to detect thunderbolt devices with PCIe cards installed to be initiated on startup, if its available as an option in your BIOS settings.</p>

<h3 id="summary">Summary</h3>

<p>The thunderbolt3 controller in Ubuntu runs as a background service of <strong>boltd</strong> which can be upgraded manually to a later version to address issues of force shutdowns. Note that I only tested version 0.7.0. since its the only version I can get to work with the GNOME control panel.</p>

<p>Happy hacking !!!</p>

</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="https://www.cheeyeo.dev/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:f/mnqwaypk"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2021 Chee Yeo<br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>




  

  <script src="/assets/site.min-fc110d15723a68aba602939bc68958f7.js" type="text/javascript" async></script>
</body>
</html>
