<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Rack::Cache in Rails 5 &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Setting up and using Rack::Cache in Rails 5.">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="ruby, rails5, cache, http">
    <link rel="canonical" href="https://www.cheeyeo.dev/ruby/rails5/cache/http/2016/08/09/rack-cache-rails/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Blog of software writer Chee Yeo" href="/feed.xml" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202302141635" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Rack::Cache in Rails 5">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="https://www.cheeyeo.dev/ruby/rails5/cache/http/2016/08/09/rack-cache-rails/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Rack::Cache in Rails 5</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">August 9, 2016</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/ruby">ruby</a>
      </li>
      
      <li>
        <a href="/categories/rails5">rails5</a>
      </li>
      
      <li>
        <a href="/categories/cache">cache</a>
      </li>
      
      <li>
        <a href="/categories/http">http</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p>Rack::Cache is a middleware which acts as a proxy cache between your client and the app. Initial requests are sent directly to the app, which then gets cached by the proxy. Subsequent requests go only to the proxy and bypass the app completely. It is used to cache assets that don’t change often but can also be used to cache http responses.</p>

<h3 id="setting-up-caching-in-rails-5">Setting up caching in Rails 5.</h3>

<p>You need to have <code class="language-plaintext highlighter-rouge">gem rack-cache</code> specified in the Gemfile.</p>

<p>Then, run the following task:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">bin</span><span class="o">/</span><span class="n">rails</span> <span class="n">dev</span><span class="ss">:caching</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This will create an empty file <code class="language-plaintext highlighter-rouge">tmp/caching-dev.txt</code>.</p>

<p>Within <code class="language-plaintext highlighter-rouge">config/development.rb</code>, you will see the following code:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="c1"># Enable/disable caching. By default caching is disabled.</span>
  <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'tmp/caching-dev.txt'</span><span class="p">).</span><span class="nf">exist?</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="c1"># set below to true to use rack_cache</span>
    <span class="c1"># also make sure rack-cache gem in gemfile</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">rack_cache</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">verbose: </span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">metastore:   </span><span class="s1">'file:/appdir/tmp'</span><span class="p">,</span>
      <span class="ss">entitystore: </span><span class="s1">'file:/appdir/tmp'</span><span class="p">,</span>
      <span class="ss">allow_reload: </span><span class="kp">true</span>
    <span class="p">}</span>

    <span class="n">config</span><span class="p">.</span><span class="nf">cache_store</span> <span class="o">=</span> <span class="ss">:memory_store</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">'Cache-Control'</span> <span class="o">=&gt;</span> <span class="s1">'public, max-age=172800'</span>
    <span class="p">}</span>

  <span class="k">else</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">perform_caching</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">cache_store</span> <span class="o">=</span> <span class="ss">:null_store</span>
  <span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>I enabled <code class="language-plaintext highlighter-rouge">Rack::Cache</code> by setting the <code class="language-plaintext highlighter-rouge">config.action_dispatch.rack_cache</code> key and passing in a hash of custom options. It can also be set to <code class="language-plaintext highlighter-rouge">true</code> and it will use the defaults defined in the Rails middleware stack.</p>

<p>I have also set <code class="language-plaintext highlighter-rouge">verbose</code> to true in development mode so we can check if it is working.</p>

<p>Run <code class="language-plaintext highlighter-rouge">bin/rails middleware</code> and you should see the following:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Sendfile</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Static</span>
<span class="n">use</span> <span class="no">Module</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Executor</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The presence of <code class="language-plaintext highlighter-rouge">Module</code> under <code class="language-plaintext highlighter-rouge">ActionDispatch::Static</code> means <code class="language-plaintext highlighter-rouge">Rack::Cache</code> is loaded. You can check the <a href="https://github.com/rails/rails/blob/5-0-stable/railties/lib/rails/application/default_middleware_stack.rb">Rails default middleware stack</a> to confirm the ordering.</p>

<h3 id="workings-of-rackcache">Workings of Rack::Cache</h3>

<p>Underneath the hood, Rack::Cache processes each request through the middleware stack and compares certain http request headers to determine if it should fetch the resource from the cache or to forward it to the application.</p>

<p>There are certain conditions under which requests will bypass the cache and goes completely to the app:</p>

<ul>
  <li>
    <p>A non-GET request is made.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">allow_reload</code> is set to <code class="language-plaintext highlighter-rouge">true</code> in the configuration and client sends a <code class="language-plaintext highlighter-rouge">Cache-Control: no-cache</code> header</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">allow_revalidate</code> is set to <code class="language-plaintext highlighter-rouge">true</code> in the configuration and client sends a <code class="language-plaintext highlighter-rouge">Cache-Control: max-age=0</code> header</p>
  </li>
  <li>
    <p>if the header contains authorization fields such as <code class="language-plaintext highlighter-rouge">Authorization</code> or ‘Cookie’, in which case Rack::Cache considers it to be private and will not cache it.</p>
  </li>
</ul>

<p>This means that if you are using http conditionals methods in your controller actions such as <code class="language-plaintext highlighter-rouge">stale?</code> method, it might lead to surprising behaviour.</p>

<p>Given an example application with a Users controller which has a conditional:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">all</span>

    <span class="k">if</span> <span class="n">stale?</span><span class="p">(</span><span class="ss">etag: </span><span class="vi">@users</span><span class="p">,</span> <span class="ss">last_modified: </span><span class="vi">@users</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="ss">:updated_at</span><span class="p">),</span> <span class="ss">public: </span><span class="kp">true</span><span class="p">)</span>
      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">html</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The option <code class="language-plaintext highlighter-rouge">public</code> must be set to <code class="language-plaintext highlighter-rouge">true</code> to allow Rack::Cache to store the content.</p>

<p>The first request will bypass <code class="language-plaintext highlighter-rouge">Rack::Cache</code>, hits the application and returns a 200 response but also the additional headers:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre>curl <span class="nt">-i</span> http://localhost:3000/users

<span class="c"># Response Headers</span>
<span class="c"># ...</span>
X-Rack-Cache: miss, ignore, store
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="no">Started</span> <span class="no">GET</span> <span class="s2">"/users"</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span> <span class="mi">16</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">36</span> <span class="o">+</span><span class="mo">0100</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">SchemaMigration</span> <span class="no">Load</span> <span class="p">(</span><span class="mf">0.3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="sb">`schema_migrations`</span><span class="p">.</span><span class="nf">*</span> <span class="no">FROM</span> <span class="sb">`schema_migrations`</span>
<span class="no">Processing</span> <span class="n">by</span> <span class="no">UsersController</span><span class="c1">#index as */*</span>
   <span class="p">(</span><span class="mf">0.4</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="no">MAX</span><span class="p">(</span><span class="sb">`users`</span><span class="p">.</span><span class="nf">`</span><span class="n">updated_at</span><span class="sb">`) FROM `</span><span class="n">users</span><span class="sb">`
   (0.3ms)  SELECT COUNT(*) AS `</span><span class="n">size</span><span class="sb">`, MAX(`</span><span class="n">users</span><span class="sb">`.`</span><span class="n">updated_at</span><span class="sb">`) AS timestamp FROM `</span><span class="n">users</span><span class="sb">`
  Rendering users/index.html.erb within layouts/application
  User Load (0.3ms)  SELECT `</span><span class="n">users</span><span class="sb">`.* FROM `</span><span class="n">users</span><span class="sb">`
  Rendered users/index.html.erb within layouts/application (9.0ms)
Completed 200 OK in 347ms (Views: 321.2ms | ActiveRecord: 4.7ms)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">X-Rack-Cache: miss</code> means that the response is not found in the cache store so it is fetched from the application and then stored within the cache.</p>

<p>A further request shows the following:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="c"># request</span>
curl <span class="nt">-i</span> http://localhost:3000/users

<span class="c"># part of the response headers</span>
<span class="c"># ....</span>
X-Rack-Cache: stale, valid, store
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="no">Started</span> <span class="no">GET</span> <span class="s2">"/users"</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span> <span class="mi">16</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">56</span> <span class="o">+</span><span class="mo">0100</span>
<span class="no">Processing</span> <span class="n">by</span> <span class="no">UsersController</span><span class="c1">#index as */*</span>
   <span class="p">(</span><span class="mf">0.4</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="no">MAX</span><span class="p">(</span><span class="sb">`users`</span><span class="p">.</span><span class="nf">`</span><span class="n">updated_at</span><span class="sb">`) FROM `</span><span class="n">users</span><span class="sb">`
   (0.3ms)  SELECT COUNT(*) AS `</span><span class="n">size</span><span class="sb">`, MAX(`</span><span class="n">users</span><span class="sb">`.`</span><span class="n">updated_at</span><span class="sb">`) AS timestamp FROM `</span><span class="n">users</span><span class="sb">`
Completed 304 Not Modified in 3ms (ActiveRecord: 0.7ms)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Note that the application is now returning a 304 response and no rendering has occured on the application side but we still receive a HTML response in the terminal.</p>

<p>This is because <code class="language-plaintext highlighter-rouge">Rack::Cache</code> has stored the initial first request and is returning it as the response, bypassing the application completely.</p>

<p>The <code class="language-plaintext highlighter-rouge">X-Rack-Cache</code> header indicates that there is a cache hit and it is rendering the content directly from the cache store, which is specified in the <code class="language-plaintext highlighter-rouge">entitystore</code> configuration directory.</p>

<p>If you look within this directory, you will see some folders. The <code class="language-plaintext highlighter-rouge">X-Content-Digest</code> shows the location of this cached response: the first 2 digits denote the directory and the remaining characters are the filename.</p>

<p>In our example above, we have:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="c"># &lt;11&gt; directory</span>
<span class="c"># &lt;463e97d33861d8ca81e9507e1d8d2e85cf2368&gt; filename</span>

X-Content-Digest: 11463e97d33861d8ca81e9507e1d8d2e85cf2368
</pre></td></tr></tbody></table></code></pre></figure>

<p>which means the cached html fragment is stored in <code class="language-plaintext highlighter-rouge">tmp/11/463e97d33861d8ca81e9507e1d8d2e85cf2368</code>. Opening it should show the entire html response.</p>

<p>By sending an <code class="language-plaintext highlighter-rouge">ETag</code> or <code class="language-plaintext highlighter-rouge">Last-Modified</code> header value that matches, we will not receive any html content back as no rendering has taken place, which is similar to just having http caching on its own.</p>

<p>One point of note is that Rails 5 use <code class="language-plaintext highlighter-rouge">weak etags</code> by default, which means you would need to change the curl syntax to get it to work (note the W/ prefix):</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>curl <span class="nt">-i</span> <span class="nt">-H</span> <span class="s1">'If-None-Match: W/"e2b3d25cf8426f3cc00dcd43f8ac2148"'</span> http://localhost:3000/users
</pre></td></tr></tbody></table></code></pre></figure>

<p>If you have <code class="language-plaintext highlighter-rouge">allow_reload</code> or <code class="language-plaintext highlighter-rouge">allow_revalidate</code> set, you can always bypass the cache, which is useful for testing:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>curl <span class="nt">-i</span> <span class="nt">-H</span> <span class="s1">'Cache-Control: no-cache'</span> http://localhost:3000/users
</pre></td></tr></tbody></table></code></pre></figure>

<p>This will cause the rendering to occur and invalidate the cache.</p>

<p>In Rails 5, ActiveRecord relation objects now return a cache key of the following format:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre>&lt;class of records&gt;/query-&lt;md5 <span class="nb">hash</span><span class="o">&gt;</span>-&lt;nos of records&gt;-&lt;timestamp of most updated record <span class="k">in </span>collection&gt;

<span class="s2">"users/query-b37955d0f26d583466428665d31ecd71-3-20160809153910000000"</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>In our UsersController, since we are passing <code class="language-plaintext highlighter-rouge">@users</code> to the <code class="language-plaintext highlighter-rouge">etag</code> parameter, Rails will automatically use the above to calculate the cache key.</p>

<p>Even if the html template were to be updated, Rack::Cache will keep rendering the cached version.</p>

<p>Only when a single user in the returned relation is updated will it render the new template changes again since the cache key will be invalidated.</p>

<p>This might cause some confusion in development mode but can be easily bypassed by updating the <code class="language-plaintext highlighter-rouge">updated_at</code> field of any user in a console:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>  <span class="o">&gt;&gt;</span> <span class="no">User</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">touch</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Subsequent request will now render the updated content:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre>curl <span class="nt">-i</span> http://localhost:3000/users

<span class="c"># renders the updated content and storing it in the cache</span>
X-Rack-Cache: stale, invalid, ignore, store
</pre></td></tr></tbody></table></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">X-Rack-Cache: stale, invalid, ignore, store</code> indicates that the updated content has been fetched and stored in the cache. Further request will return <code class="language-plaintext highlighter-rouge">X-Rack-Cache: stale, valid, store</code>, with a status code of 304 from the application and the cached content from the proxy.</p>

<p>I hope this has helped in understanding and using <code class="language-plaintext highlighter-rouge">Rack::Cache</code> in Rails 5.</p>

<p>Stay curious and keep hacking!</p>

<h3 id="further-information">Further information</h3>
<ul>
  <li><a href="https://github.com/rtomayko/rack-cache">rack-cache github source</a></li>
  <li><a href="https://github.com/rtomayko/rack-cache/blob/master/doc/configuration.markdown">rack cache configuration options</a></li>
</ul>

</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="https://www.cheeyeo.dev/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:f/mnqwaypk"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2023 Chee Yeo</strong><br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>



</body>
</html>
