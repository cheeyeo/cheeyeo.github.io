<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Using Ruby Refinements in Rails &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Refining NilClass over using try">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="rails, ruby">
    <link rel="canonical" href="https://www.cheeyeo.dev/ruby/rails/2016/06/29/refinements-in-rails/">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Lato:900,300|Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/assets/global-ef3d2a30bafae51bdca9401db921816a.css" type="text/css">

    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <script src="/assets/modernizr.custom-d69c837039e5f58032e4842950ab13c3.js" async></script>

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Using Ruby Refinements in Rails">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="/ruby/rails/2016/06/29/refinements-in-rails/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Using Ruby Refinements in Rails</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">June 29, 2016</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/rails">rails</a>
      </li>
      
      <li>
        <a href="/categories/ruby">ruby</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p>Its not very often I get the chance to use refinements in Rails. My past experiences with it in the context of Rails applications has been less than satisfactory due to the way the framework handles code reloading and the way refinements’ scopes work.</p>

<p>However, I feel strongly enough to use refinements in a recent project due to the use / abuse of <code>ActiveSupport#try</code> method.</p>

<p>Supposing we have an Order class that has a single attribute, <code>date</code>. Also assuming that we have a method which calls <code>to_date</code> on that attribute like so:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">Order</span>
<span class="lineno"> 2</span>   <span class="kp">attr_accessor</span> <span class="ss">:date</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>   <span class="k">def</span> <span class="nf">confirmed_date</span>
<span class="lineno"> 5</span>     <span class="vi">@date</span><span class="o">.</span><span class="n">to_date</span>
<span class="lineno"> 6</span>   <span class="k">end</span>
<span class="lineno"> 7</span> <span class="k">end</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="n">o</span> <span class="o">=</span> <span class="no">Order</span><span class="o">.</span><span class="n">new</span>
<span class="lineno">10</span> <span class="nb">puts</span> <span class="n">o</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_date</span></code></pre></div>

<p>If the <code>date</code> attribute is nil, the above would throw an <code>undefined method on NilClass error</code>. A common pattern in Rails application is to wrap the above in a <code>try</code> method from ActiveSupport:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="nb">require</span> <span class="s1">&#39;active_support&#39;</span>
<span class="lineno"> 2</span> <span class="nb">require</span> <span class="s1">&#39;active_support/core_ext/object/try&#39;</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="k">class</span> <span class="nc">Order</span>
<span class="lineno"> 5</span>   <span class="kp">attr_accessor</span> <span class="ss">:date</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="k">def</span> <span class="nf">confirmed_date</span>
<span class="lineno"> 8</span>     <span class="vi">@date</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:to_date</span><span class="p">)</span>
<span class="lineno"> 9</span>   <span class="k">end</span>
<span class="lineno">10</span> <span class="k">end</span></code></pre></div>

<p>Using the <code>try</code> method will return <code>nil</code> and not throw an exception. Underneath the hood, ActiveSupport has overridden <code>NilClass</code> with a <code>try</code> method to only return nil, disregarding any arguments passed into it:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="c1"># from lib/active_support/core_ext/object/try.rb</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">class</span> <span class="nc">NilClass</span>
<span class="lineno"> 4</span>   <span class="k">def</span> <span class="nf">try</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="lineno"> 5</span>     <span class="kp">nil</span>
<span class="lineno"> 6</span>   <span class="k">end</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>   <span class="k">def</span> <span class="nf">try!</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="lineno"> 9</span>     <span class="kp">nil</span>
<span class="lineno">10</span>   <span class="k">end</span>
<span class="lineno">11</span> <span class="k">end</span></code></pre></div>

<p>This pattern is common in most Rails applications, and if you study the Rails source code, there are many examples given of this specific usage of <code>try</code>. But from a ruby perspective, this seems like a kind of anti-pattern to me. NilClass is just another object from the ruby ecosystem so why can’t we just define the missing <code>to_date</code> method on it in this case and not have to worry about calling another method from a dependency to deal with it? My immediate thought is to apply the NullObject pattern but I think it is overkill in this use case since there is only 1 method calling <code>try</code>.</p>

<p>Rather than overriding NilClass, my approach is to define <code>to_date</code> on it using Ruby refinements which I can use in the context I decide is applicable like so:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="k">module</span> <span class="nn">NilClassRefinements</span>
<span class="lineno"> 2</span>   <span class="n">refine</span> <span class="no">NilClass</span> <span class="k">do</span>
<span class="lineno"> 3</span>     <span class="k">def</span> <span class="nf">to_date</span>
<span class="lineno"> 4</span>       <span class="kp">nil</span>
<span class="lineno"> 5</span>     <span class="k">end</span>
<span class="lineno"> 6</span>   <span class="k">end</span>
<span class="lineno"> 7</span> <span class="k">end</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="n">using</span> <span class="no">NilClassRefinements</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="k">class</span> <span class="nc">Order</span>
<span class="lineno">12</span>   <span class="kp">attr_accessor</span> <span class="ss">:date</span>
<span class="lineno">13</span> 
<span class="lineno">14</span>   <span class="k">def</span> <span class="nf">confirmed_date</span>
<span class="lineno">15</span>     <span class="vi">@date</span><span class="o">.</span><span class="n">to_date</span>
<span class="lineno">16</span>   <span class="k">end</span>
<span class="lineno">17</span> <span class="k">end</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="n">o</span> <span class="o">=</span> <span class="no">Order</span><span class="o">.</span><span class="n">new</span>
<span class="lineno">20</span> <span class="nb">puts</span> <span class="n">o</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_date</span><span class="o">.</span><span class="n">inspect</span></code></pre></div>

<p>The above also returns <code>nil</code> if <code>@date</code> is nil and is easier to understand with the added benefit of not overriding the core data types in Ruby.</p>

<p>Stay curious and keep hacking!</p>

</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="https://www.cheeyeo.dev/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:ckyeo.1@gmail.com"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2021 Chee Yeo<br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>




  

  <script src="/assets/site.min-fc110d15723a68aba602939bc68958f7.js" type="text/javascript" async></script>
</body>
</html>
