<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Using Ruby Refinements in Rails &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Refining NilClass over using try">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="ruby, rails">
    <link rel="canonical" href="https://www.cheeyeo.dev/ruby/rails/2016/06/29/refinements-in-rails/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Blog of software writer Chee Yeo" href="/feed.xml" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202302141635" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Using Ruby Refinements in Rails">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="https://www.cheeyeo.dev/ruby/rails/2016/06/29/refinements-in-rails/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Using Ruby Refinements in Rails</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">June 29, 2016</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/ruby">ruby</a>
      </li>
      
      <li>
        <a href="/categories/rails">rails</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p>Its not very often I get the chance to use refinements in Rails. My past experiences with it in the context of Rails applications has been less than satisfactory due to the way the framework handles code reloading and the way refinements’ scopes work.</p>

<p>However, I feel strongly enough to use refinements in a recent project due to the use / abuse of <code class="language-plaintext highlighter-rouge">ActiveSupport#try</code> method.</p>

<p>Supposing we have an Order class that has a single attribute, <code class="language-plaintext highlighter-rouge">date</code>. Also assuming that we have a method which calls <code class="language-plaintext highlighter-rouge">to_date</code> on that attribute like so:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Order</span>
  <span class="nb">attr_accessor</span> <span class="ss">:date</span>

  <span class="k">def</span> <span class="nf">confirmed_date</span>
    <span class="vi">@date</span><span class="p">.</span><span class="nf">to_date</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">o</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span>
<span class="nb">puts</span> <span class="n">o</span><span class="p">.</span><span class="nf">date</span><span class="p">.</span><span class="nf">to_date</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>If the <code class="language-plaintext highlighter-rouge">date</code> attribute is nil, the above would throw an <code class="language-plaintext highlighter-rouge">undefined method on NilClass error</code>. A common pattern in Rails application is to wrap the above in a <code class="language-plaintext highlighter-rouge">try</code> method from ActiveSupport:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="nb">require</span> <span class="s1">'active_support'</span>
<span class="nb">require</span> <span class="s1">'active_support/core_ext/object/try'</span>

<span class="k">class</span> <span class="nc">Order</span>
  <span class="nb">attr_accessor</span> <span class="ss">:date</span>

  <span class="k">def</span> <span class="nf">confirmed_date</span>
    <span class="vi">@date</span><span class="p">.</span><span class="nf">try</span><span class="p">(</span><span class="ss">:to_date</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Using the <code class="language-plaintext highlighter-rouge">try</code> method will return <code class="language-plaintext highlighter-rouge">nil</code> and not throw an exception. Underneath the hood, ActiveSupport has overridden <code class="language-plaintext highlighter-rouge">NilClass</code> with a <code class="language-plaintext highlighter-rouge">try</code> method to only return nil, disregarding any arguments passed into it:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="c1"># from lib/active_support/core_ext/object/try.rb</span>

<span class="k">class</span> <span class="nc">NilClass</span>
  <span class="k">def</span> <span class="nf">try</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">try!</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This pattern is common in most Rails applications, and if you study the Rails source code, there are many examples given of this specific usage of <code class="language-plaintext highlighter-rouge">try</code>. But from a ruby perspective, this seems like a kind of anti-pattern to me. NilClass is just another object from the ruby ecosystem so why can’t we just define the missing <code class="language-plaintext highlighter-rouge">to_date</code> method on it in this case and not have to worry about calling another method from a dependency to deal with it? My immediate thought is to apply the NullObject pattern but I think it is overkill in this use case since there is only 1 method calling <code class="language-plaintext highlighter-rouge">try</code>.</p>

<p>Rather than overriding NilClass, my approach is to define <code class="language-plaintext highlighter-rouge">to_date</code> on it using Ruby refinements which I can use in the context I decide is applicable like so:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">NilClassRefinements</span>
  <span class="n">refine</span> <span class="no">NilClass</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">to_date</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">using</span> <span class="no">NilClassRefinements</span>

<span class="k">class</span> <span class="nc">Order</span>
  <span class="nb">attr_accessor</span> <span class="ss">:date</span>

  <span class="k">def</span> <span class="nf">confirmed_date</span>
    <span class="vi">@date</span><span class="p">.</span><span class="nf">to_date</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">o</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span>
<span class="nb">puts</span> <span class="n">o</span><span class="p">.</span><span class="nf">date</span><span class="p">.</span><span class="nf">to_date</span><span class="p">.</span><span class="nf">inspect</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The above also returns <code class="language-plaintext highlighter-rouge">nil</code> if <code class="language-plaintext highlighter-rouge">@date</code> is nil and is easier to understand with the added benefit of not overriding the core data types in Ruby.</p>

<p>Stay curious and keep hacking!</p>

</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="https://www.cheeyeo.dev/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:f/mnqwaypk"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2023 Chee Yeo</strong><br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>



</body>
</html>
