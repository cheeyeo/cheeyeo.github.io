<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Content Security Policy in Rails &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Using Content Security Policy in Rails">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="ruby, rails">
    <link rel="canonical" href="https://www.cheeyeo.dev/ruby/rails/2015/03/05/content-security-policy/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Blog of software writer Chee Yeo" href="/feed.xml" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202212111652" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Content Security Policy in Rails">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="https://www.cheeyeo.dev/ruby/rails/2015/03/05/content-security-policy/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Content Security Policy in Rails</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">March 5, 2015</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/ruby">ruby</a>
      </li>
      
      <li>
        <a href="/categories/rails">rails</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p><a href="http://www.w3.org/TR/2015/CR-CSP2-20150219/" target="_blank">Content Security Policy</a> is a W3C specificaton that provides an additional layer of defence against XSS(Cross site scripting) and other content-based injection attacks by specifying a whitelist to restrict where a HTML page can load assets from.</p>

<p>It works by setting a HTTP header of Content-Security-Policy whereby one can define a whitelist of trusted sources of content which a browser will execute in the context of your application. Any untrusted sources will generate an error in the browser and will not be executed.</p>

<p>A good example of this is in the use of third party javascripts such as social media buttons. For example, we can define a simple rule to allow for the embed of google plus javascript in our webpages as follows:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">Content-Security-Policy: script-src 'self' https://apis.google.com</code></pre></figure>

<p>The rule above will only allow for javascripts from your local domain and that of apis.google.com to be loaded and executed in your origin. If you are building any application which allows for user generated content, this is an additional layer of security in addition to sanitizing the actual user data before rendering.</p>

<p>Since CSP is only a HTTP header we can actually implement it quite easily in say a before_action block in ApplicationController. I wanted to show how this can be done using the <a href="https://github.com/twitter/secureheaders" target="_blank">secure_headers gem by Twitter</a> which allows for a more centralized and configurable approach.</p>

<p>First start by installing the gem in your application:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'secure_headers'</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/twitter/secureheaders'</span><span class="p">,</span> <span class="ss">:branch</span> <span class="o">=&gt;</span> <span class="s1">'master'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">'secure_headers'</span></code></pre></figure>

<p>Then define an initializer say config/initializers/secure_headers.rb:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">::</span><span class="no">SecureHeaders</span><span class="o">::</span><span class="no">Configuration</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">csp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:default_src</span> <span class="o">=&gt;</span> <span class="s2">"https: self"</span><span class="p">,</span>
    <span class="ss">:script_src</span> <span class="o">=&gt;</span> <span class="s2">"https: self"</span><span class="p">,</span>
    <span class="ss">:img_src</span> <span class="o">=&gt;</span> <span class="s2">"self"</span><span class="p">,</span>
    <span class="ss">:tag_report_uri</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
    <span class="ss">:enforce</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
    <span class="ss">:app_name</span> <span class="o">=&gt;</span> <span class="s1">'secure_headers_test'</span><span class="p">,</span>
    <span class="ss">:report_uri</span> <span class="o">=&gt;</span> <span class="s1">'/csp_reports'</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># and then simply include this in application_controller.rb</span>
<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">ensure_security_headers</span>
<span class="k">end</span></code></pre></figure>

<p>The rules in CSP are cascading. The <strong>‘default_src’</strong> key is the default fallback if any of the src attributes are not defined. For example, if we did not define an img_src attribute, it will load images with a <strong>‘https:’</strong> prefix regardless of its origin as well as images from your origin. The following images will be loaded:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"https://example.com/my_image.png"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/assets/my_other_image.png"</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>However, since we have defined <strong>‘img_src’</strong> to be only from <strong>‘self’</strong>, only the second image will be loaded:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="c">&lt;!-- throws an error in the chrome console of Refused to load the image 'https://example.com/my_image.png' because it violates the following Content Security Policy directive: "img-src 'self' data:".--&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"https://example.com/my_image.png"</span> <span class="nt">/&gt;</span>

<span class="c">&lt;!-- this loads fine--&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/assets/my_other_image.png"</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>In terms of inline scripts and styles, CSP will allow it if <strong>‘inline’</strong> is passed to the attribute definition. However, this will make it less secure than its intended purposes. It may require some refactoring to move some of the inline scripts into separate js files but this may not be possible all the time if you are using for example, content_for blocks to generate javascript on certain pages of your application.</p>

<p>secure_headers supports CSP Level 2 which allows for setting a <strong>‘nonce’</strong> to your script tags but will block everything else:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="ss">:csp</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="ss">:default_src</span> <span class="o">=&gt;</span> <span class="s1">'self'</span><span class="p">,</span>
  <span class="ss">:script_src</span> <span class="o">=&gt;</span> <span class="s1">'self nonce'</span>
<span class="p">}</span>

<span class="o">&lt;</span><span class="n">script</span> <span class="n">nonce</span><span class="o">=</span><span class="s2">"&lt;%= @content_security_policy_nonce %&gt;"</span><span class="o">&gt;</span>
  <span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">"whitelisted, so this will execute"</span><span class="p">)</span>
<span class="o">&lt;</span><span class="sr">/script&gt;

&lt;script&gt;
  console.log("not whitelisted, won't execute")
&lt;/s</span><span class="n">cript</span><span class="o">&gt;</span></code></pre></figure>

<p>Another cool feature of CSP is its built in reporting functionality. By setting <strong>‘report_uri’</strong> and a url, CSP will automatically post a JSON request to the specified endpoint if any violation occurs. This is extremely useful in debugging CSP implementations.</p>

<p>Assuming we have a route ‘/csp_reports’, we can gather the information like so:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># within CspReports controller</span>

<span class="k">class</span> <span class="nc">CspReportsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">"app_name"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"SecureHeadersTest"</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">read</span>

      <span class="n">report</span> <span class="o">=</span> <span class="no">CspReport</span><span class="p">.</span><span class="nf">new</span>

      <span class="n">h</span> <span class="o">=</span> <span class="no">Oj</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

      <span class="n">report</span><span class="p">.</span><span class="nf">enforce</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">"enforce"</span><span class="p">]</span>
      <span class="n">report</span><span class="p">.</span><span class="nf">app_name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">"app_name"</span><span class="p">]</span>
      <span class="n">report</span><span class="p">.</span><span class="nf">document_uri</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">"csp-report"</span><span class="p">][</span><span class="s2">"document-uri"</span><span class="p">]</span>
      <span class="n">report</span><span class="p">.</span><span class="nf">referrer</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">"csp-report"</span><span class="p">][</span><span class="s2">"referrer"</span><span class="p">]</span>
      <span class="n">report</span><span class="p">.</span><span class="nf">violated_directive</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">"csp-report"</span><span class="p">][</span><span class="s2">"violated-directive"</span><span class="p">]</span>
      <span class="n">report</span><span class="p">.</span><span class="nf">effective_directive</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">"csp-report"</span><span class="p">][</span><span class="s2">"effective-directive"</span><span class="p">]</span>
      <span class="n">report</span><span class="p">.</span><span class="nf">original_policy</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">"csp-report"</span><span class="p">][</span><span class="s2">"original-policy"</span><span class="p">]</span>
      <span class="n">report</span><span class="p">.</span><span class="nf">blocked_uri</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">"csp-report"</span><span class="p">][</span><span class="s2">"blocked-uri"</span><span class="p">]</span>
      <span class="n">report</span><span class="p">.</span><span class="nf">status_code</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">"csp-report"</span><span class="p">][</span><span class="s2">"status-code"</span><span class="p">]</span>

      <span class="n">report</span><span class="p">.</span><span class="nf">save!</span>
    <span class="k">end</span>

    <span class="n">head</span> <span class="ss">:ok</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>An <a href="https://github.com/cheeyeo/Secure-headers-test-app" target="_blank">example Rails 4.2 application</a> has been created to showcase the above.</p>

<p>Happy Hacking!</p>


</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="https://www.cheeyeo.dev/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:f/mnqwaypk"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2022 Chee Yeo</strong><br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>



</body>
</html>
