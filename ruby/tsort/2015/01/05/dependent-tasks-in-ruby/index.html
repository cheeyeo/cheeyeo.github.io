<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Running dependent tasks in Ruby with TSort &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="How to run dependent tasks in Ruby with TSort">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="ruby, tsort">
    <link rel="canonical" href="https://www.cheeyeo.dev/ruby/tsort/2015/01/05/dependent-tasks-in-ruby/">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Lato:900,300|Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/assets/global-ef3d2a30bafae51bdca9401db921816a.css" type="text/css">

    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <script src="/assets/modernizr.custom-d69c837039e5f58032e4842950ab13c3.js" async></script>

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Running dependent tasks in Ruby with TSort">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="/ruby/tsort/2015/01/05/dependent-tasks-in-ruby/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Running dependent tasks in Ruby with TSort</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">January 5, 2015</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/ruby">ruby</a>
      </li>
      
      <li>
        <a href="/categories/tsort">tsort</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p>I was intrigued to learn more about the <a href="http://www.ruby-doc.org/stdlib-2.1.2/libdoc/tsort/rdoc/TSort.html" target="_blank">TSort</a> module after reading about it from a blog post.</p>

<p>In summary, TSort implements toplogical sorting and determine the order to run a list of dependencies. You may have come across such scenarios when using tools such as Bundler
and Rake.</p>

<p>After using other task runners such as Grunt.js I wonder if I could implement
a very simple task runner in Ruby using TSort:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="nb">require</span> <span class="s1">&#39;tsort&#39;</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="no">TASKS</span><span class="o">=</span><span class="p">{</span>
<span class="lineno"> 4</span>   <span class="ss">:one</span> <span class="o">=&gt;</span> <span class="o">[]</span><span class="p">,</span>
<span class="lineno"> 5</span>   <span class="ss">:two</span> <span class="o">=&gt;</span> <span class="o">[]</span><span class="p">,</span>
<span class="lineno"> 6</span>   <span class="ss">:three</span> <span class="o">=&gt;</span> <span class="o">[]</span><span class="p">,</span>
<span class="lineno"> 7</span>   <span class="ss">:four</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:one</span><span class="p">,</span> <span class="ss">:three</span><span class="o">]</span><span class="p">,</span>
<span class="lineno"> 8</span>   <span class="ss">:five</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:four</span><span class="p">,</span> <span class="ss">:two</span><span class="o">]</span>
<span class="lineno"> 9</span> <span class="p">}</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="k">def</span> <span class="nf">one</span>
<span class="lineno">12</span>   <span class="nb">puts</span> <span class="s2">&quot;Task one ran!&quot;</span>
<span class="lineno">13</span>   <span class="n">command</span> <span class="s2">&quot;date &#39;+TASK 1 DATE: %m/%d/%y%nTASK 1 TIME:%H:%M:%S&#39; &gt; t1&quot;</span>
<span class="lineno">14</span> <span class="k">end</span>
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="k">def</span> <span class="nf">two</span>
<span class="lineno">17</span>   <span class="nb">puts</span> <span class="s2">&quot;Task two ran!&quot;</span>
<span class="lineno">18</span>   <span class="n">command</span> <span class="s2">&quot;date &#39;+TASK 2 DATE: %m/%d/%y%nTASK 2 TIME:%H:%M:%S&#39; &gt; t2&quot;</span>
<span class="lineno">19</span> <span class="k">end</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="k">def</span> <span class="nf">three</span>
<span class="lineno">22</span>   <span class="nb">puts</span> <span class="s2">&quot;Task three ran!&quot;</span>
<span class="lineno">23</span>   <span class="n">command</span> <span class="s2">&quot;date &#39;+TASK 3 DATE: %m/%d/%y%nTASK 3 TIME:%H:%M:%S&#39; &gt; t3&quot;</span>
<span class="lineno">24</span> <span class="k">end</span>
<span class="lineno">25</span> 
<span class="lineno">26</span> <span class="k">def</span> <span class="nf">four</span>
<span class="lineno">27</span>   <span class="nb">puts</span> <span class="s2">&quot;Task four ran!&quot;</span>
<span class="lineno">28</span>   <span class="n">command</span> <span class="s1">&#39;cat t1 t3 &gt; t4&#39;</span>
<span class="lineno">29</span> <span class="k">end</span>
<span class="lineno">30</span> 
<span class="lineno">31</span> <span class="k">def</span> <span class="nf">five</span>
<span class="lineno">32</span>   <span class="nb">puts</span> <span class="s2">&quot;Task five ran!&quot;</span>
<span class="lineno">33</span>   <span class="n">command</span> <span class="s1">&#39;cat t4 t2 &gt; t5&#39;</span>
<span class="lineno">34</span> <span class="k">end</span>
<span class="lineno">35</span> 
<span class="lineno">36</span> <span class="k">def</span> <span class="nf">command</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<span class="lineno">37</span>   <span class="nb">puts</span> <span class="s2">&quot;Running command: </span><span class="si">#{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">38</span>   <span class="nb">system</span> <span class="n">arg</span>
<span class="lineno">39</span>   <span class="nb">puts</span>
<span class="lineno">40</span> <span class="k">end</span>
<span class="lineno">41</span> 
<span class="lineno">42</span> <span class="k">def</span> <span class="nf">task_to_run</span>
<span class="lineno">43</span>   <span class="k">yield</span> <span class="ss">:five</span>
<span class="lineno">44</span> <span class="k">end</span>
<span class="lineno">45</span> 
<span class="lineno">46</span> <span class="k">def</span> <span class="nf">dependent_tasks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
<span class="lineno">47</span>   <span class="no">TASKS</span><span class="o">[</span><span class="n">t</span><span class="o">].</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
<span class="lineno">48</span> <span class="k">end</span>
<span class="lineno">49</span> 
<span class="lineno">50</span> <span class="n">each_node</span> <span class="o">=</span> <span class="nb">method</span><span class="p">(</span><span class="ss">:task_to_run</span><span class="p">)</span>
<span class="lineno">51</span> <span class="n">each_child</span> <span class="o">=</span> <span class="nb">method</span><span class="p">(</span><span class="ss">:dependent_tasks</span><span class="p">)</span>
<span class="lineno">52</span> 
<span class="lineno">53</span> <span class="nb">puts</span> <span class="s2">&quot;Running tasks in the following order:&quot;</span>
<span class="lineno">54</span> 
<span class="lineno">55</span> <span class="nb">puts</span> <span class="no">TSort</span><span class="o">.</span><span class="n">tsort</span><span class="p">(</span><span class="n">each_node</span><span class="p">,</span> <span class="n">each_child</span><span class="p">)</span>
<span class="lineno">56</span> 
<span class="lineno">57</span> <span class="nb">puts</span>
<span class="lineno">58</span> 
<span class="lineno">59</span> <span class="no">TSort</span><span class="o">.</span><span class="n">each_strongly_connected_component_from</span><span class="p">(</span><span class="ss">:five</span><span class="p">,</span> <span class="n">each_child</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">scc</span><span class="o">|</span>
<span class="lineno">60</span>   <span class="nb">method</span><span class="p">(</span><span class="n">scc</span><span class="o">.</span><span class="n">first</span><span class="p">)</span><span class="o">.</span><span class="n">call</span>
<span class="lineno">61</span> <span class="p">}</span></code></pre></div>

<p>In the example, the TASKS hash constant defines the list of tasks that needs to be
completed. The key refers to the task name and its value is a list of dependent
tasks that needs to be completed before it can run.</p>

<p>For example, TASKS[:one] is an empty array which means it has no dependencies
and can be run first. TASKS[:four] is dependent on the completion of tasks :one
and :three. Each hash key is a symbol which corresponds to a local method.</p>

<p>We require ‘tsort’. Then we invoke the module method <a href="http://www.ruby-doc.org/stdlib-2.1.2/libdoc/tsort/rdoc/TSort.html#method-c-each_strongly_connected_component_from" target="_blank">each_strongly_connected_component_from</a>, which takes two arguments:
the starting node, which in this case, is the task :five from the TASKS hash.</p>

<p>The second argument must be an object which responds to call. ‘each_child’ is a method object
which references the ‘dependent_tasks’ method. The dependent_tasks method yields
the children of each node into a block which is processed by TSort.</p>

<p><a href="http://www.ruby-doc.org/stdlib-2.1.2/libdoc/tsort/rdoc/TSort.html#method-i-tsort" target="_blank">tsort</a> returns a list of sorted nodes from children to parents.</p>

<p>If we run the above script, this is the output we see, with task :five set as the default:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="no">Running</span> <span class="n">tasks</span> <span class="k">in</span> <span class="n">the</span> <span class="n">following</span> <span class="ss">order</span><span class="p">:</span>
<span class="lineno"> 2</span> <span class="n">one</span>
<span class="lineno"> 3</span> <span class="n">three</span>
<span class="lineno"> 4</span> <span class="n">four</span>
<span class="lineno"> 5</span> <span class="n">two</span>
<span class="lineno"> 6</span> <span class="n">five</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="no">Task</span> <span class="n">one</span> <span class="n">ran!</span>
<span class="lineno"> 9</span> <span class="n">date</span> <span class="s1">&#39;+TASK 1 DATE: %m/%d/%y%nTASK 1 TIME:%H:%M:%S&#39;</span> <span class="o">&gt;</span> <span class="n">t1</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="no">Task</span> <span class="n">three</span> <span class="n">ran!</span>
<span class="lineno">12</span> <span class="n">date</span> <span class="s1">&#39;+TASK 3 DATE: %m/%d/%y%nTASK 3 TIME:%H:%M:%S&#39;</span> <span class="o">&gt;</span> <span class="n">t3</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="no">Task</span> <span class="n">four</span> <span class="n">ran!</span>
<span class="lineno">15</span> <span class="n">cat</span> <span class="n">t1</span> <span class="n">t3</span> <span class="o">&gt;</span> <span class="n">t4</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="no">Task</span> <span class="n">two</span> <span class="n">ran!</span>
<span class="lineno">18</span> <span class="n">date</span> <span class="s1">&#39;+TASK 2 DATE: %m/%d/%y%nTASK 2 TIME:%H:%M:%S&#39;</span> <span class="o">&gt;</span> <span class="n">t2</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> <span class="no">Task</span> <span class="n">five</span> <span class="n">ran!</span>
<span class="lineno">21</span> <span class="n">cat</span> <span class="n">t4</span> <span class="n">t2</span> <span class="o">&gt;</span> <span class="n">t5</span></code></pre></div>

<p>From the output, TSort sees that TASK[:five] is dependent on tasks :four and :two.
Task :four has two children: tasks :one and three. Hence, tasks :one and :three
are executed first, followed by task :four. It proceeds to run task :two and since
it has no child nodes, task :five is then run.</p>

<p>If any of the tasks encounter an exception, execution stops at that point
and no further tasks are run. For example, if an error is raised in task one method
call:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">one</span>
<span class="lineno">2</span>   <span class="nb">puts</span> <span class="s2">&quot;Task one ran!&quot;</span>
<span class="lineno">3</span>   <span class="k">raise</span> <span class="s2">&quot;Error!&quot;</span>
<span class="lineno">4</span>   <span class="n">command</span> <span class="s2">&quot;date &#39;+TASK 1 DATE: %m/%d/%y%nTASK 1 TIME:%H:%M:%S&#39; &gt; t1&quot;</span>
<span class="lineno">5</span> <span class="k">end</span></code></pre></div>

<p>none of the other tasks are executed:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="no">Task</span> <span class="n">one</span> <span class="n">ran!</span>
<span class="lineno"> 2</span> <span class="n">tasks</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">13</span><span class="ss">:in</span> <span class="sb">`one&#39;: Error! (RuntimeError)</span>
<span class="lineno"> 3</span> <span class="sb">  from tasks.rb:62:in `</span><span class="n">call</span><span class="s1">&#39;</span>
<span class="lineno"> 4</span> <span class="s1">  from tasks.rb:62:in `block in &lt;main&gt;&#39;</span>
<span class="lineno"> 5</span>   <span class="n">from</span> <span class="sr">/Users/</span><span class="n">chee</span><span class="o">/.</span><span class="n">rvm</span><span class="o">/</span><span class="n">rubies</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tsort</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">420</span><span class="ss">:in</span> <span class="sb">`block (2 levels) in each_strongly_connected_component_from&#39;</span>
<span class="lineno"> 6</span> <span class="sb">  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:420:in `</span><span class="n">block</span> <span class="p">(</span><span class="mi">2</span> <span class="n">levels</span><span class="p">)</span> <span class="k">in</span> <span class="n">each_strongly_connected_component_from</span><span class="s1">&#39;</span>
<span class="lineno"> 7</span> <span class="s1">  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:429:in `each_strongly_connected_component_from&#39;</span>
<span class="lineno"> 8</span>   <span class="n">from</span> <span class="sr">/Users/</span><span class="n">chee</span><span class="o">/.</span><span class="n">rvm</span><span class="o">/</span><span class="n">rubies</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tsort</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">419</span><span class="ss">:in</span> <span class="sb">`block in each_strongly_connected_component_from&#39;</span>
<span class="lineno"> 9</span> <span class="sb">  from tasks.rb:53:in `</span><span class="n">each</span><span class="s1">&#39;</span>
<span class="lineno">10</span> <span class="s1">  from tasks.rb:53:in `dependent_tasks&#39;</span>
<span class="lineno">11</span>   <span class="n">from</span> <span class="sr">/Users/</span><span class="n">chee</span><span class="o">/.</span><span class="n">rvm</span><span class="o">/</span><span class="n">rubies</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tsort</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">413</span><span class="ss">:in</span> <span class="sb">`call&#39;</span>
<span class="lineno">12</span> <span class="sb">  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:413:in `</span><span class="n">each_strongly_connected_component_from</span><span class="s1">&#39;</span>
<span class="lineno">13</span> <span class="s1">  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:419:in `block in each_strongly_connected_component_from&#39;</span>
<span class="lineno">14</span>   <span class="n">from</span> <span class="n">tasks</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">53</span><span class="ss">:in</span> <span class="sb">`each&#39;</span>
<span class="lineno">15</span> <span class="sb">  from tasks.rb:53:in `</span><span class="n">dependent_tasks</span><span class="s1">&#39;</span>
<span class="lineno">16</span> <span class="s1">  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:413:in `call&#39;</span>
<span class="lineno">17</span>   <span class="n">from</span> <span class="sr">/Users/</span><span class="n">chee</span><span class="o">/.</span><span class="n">rvm</span><span class="o">/</span><span class="n">rubies</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tsort</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">413</span><span class="ss">:in</span> <span class="sb">`each_strongly_connected_component_from&#39;</span>
<span class="lineno">18</span> <span class="sb">  from tasks.rb:61:in `</span><span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span><span class="err">&#39;</span></code></pre></div>

<p>Although one could have structured the above using just arrays, TSort automatically
works out where it should start from, rather than having to work it out manually.</p>

</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="https://www.cheeyeo.dev/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:f/mnqwaypk"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2022 Chee Yeo<br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>




  

  <script src="/assets/site.min-fc110d15723a68aba602939bc68958f7.js" type="text/javascript" async></script>
</body>
</html>
