<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Running dependent tasks in Ruby with TSort &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="How to run dependent tasks in Ruby with TSort">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="ruby, tsort">
    <link rel="canonical" href="http://localhost:4000/ruby/tsort/2015/01/05/dependent-tasks-in-ruby/">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Lato:900,300|Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/assets/global-ef3d2a30bafae51bdca9401db921816a.css" type="text/css">

    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <script src="/assets/modernizr.custom-d69c837039e5f58032e4842950ab13c3.js" async></script>

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Running dependent tasks in Ruby with TSort">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="http://localhost:4000/ruby/tsort/2015/01/05/dependent-tasks-in-ruby/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Running dependent tasks in Ruby with TSort</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">January 5, 2015</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/ruby">ruby</a>
      </li>
      
      <li>
        <a href="/categories/tsort">tsort</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p>I was intrigued to learn more about the <a href="http://www.ruby-doc.org/stdlib-2.1.2/libdoc/tsort/rdoc/TSort.html" target="_blank">TSort</a> module after reading about it from a blog post.</p>

<p>In summary, TSort implements toplogical sorting and determine the order to run a list of dependencies. You may have come across such scenarios when using tools such as Bundler
and Rake.</p>

<p>After using other task runners such as Grunt.js I wonder if I could implement
a very simple task runner in Ruby using TSort:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="code"><pre><span class="nb">require</span> <span class="s1">'tsort'</span>

<span class="no">TASKS</span><span class="o">=</span><span class="p">{</span>
  <span class="ss">:one</span> <span class="o">=&gt;</span> <span class="p">[],</span>
  <span class="ss">:two</span> <span class="o">=&gt;</span> <span class="p">[],</span>
  <span class="ss">:three</span> <span class="o">=&gt;</span> <span class="p">[],</span>
  <span class="ss">:four</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:one</span><span class="p">,</span> <span class="ss">:three</span><span class="p">],</span>
  <span class="ss">:five</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:four</span><span class="p">,</span> <span class="ss">:two</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">one</span>
  <span class="nb">puts</span> <span class="s2">"Task one ran!"</span>
  <span class="n">command</span> <span class="s2">"date '+TASK 1 DATE: %m/%d/%y%nTASK 1 TIME:%H:%M:%S' &gt; t1"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">two</span>
  <span class="nb">puts</span> <span class="s2">"Task two ran!"</span>
  <span class="n">command</span> <span class="s2">"date '+TASK 2 DATE: %m/%d/%y%nTASK 2 TIME:%H:%M:%S' &gt; t2"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">three</span>
  <span class="nb">puts</span> <span class="s2">"Task three ran!"</span>
  <span class="n">command</span> <span class="s2">"date '+TASK 3 DATE: %m/%d/%y%nTASK 3 TIME:%H:%M:%S' &gt; t3"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">four</span>
  <span class="nb">puts</span> <span class="s2">"Task four ran!"</span>
  <span class="n">command</span> <span class="s1">'cat t1 t3 &gt; t4'</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">five</span>
  <span class="nb">puts</span> <span class="s2">"Task five ran!"</span>
  <span class="n">command</span> <span class="s1">'cat t4 t2 &gt; t5'</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">command</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Running command: </span><span class="si">#{</span><span class="n">arg</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">system</span> <span class="n">arg</span>
  <span class="nb">puts</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">task_to_run</span>
  <span class="k">yield</span> <span class="ss">:five</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">dependent_tasks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="no">TASKS</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">each_node</span> <span class="o">=</span> <span class="nb">method</span><span class="p">(</span><span class="ss">:task_to_run</span><span class="p">)</span>
<span class="n">each_child</span> <span class="o">=</span> <span class="nb">method</span><span class="p">(</span><span class="ss">:dependent_tasks</span><span class="p">)</span>

<span class="nb">puts</span> <span class="s2">"Running tasks in the following order:"</span>

<span class="nb">puts</span> <span class="no">TSort</span><span class="p">.</span><span class="nf">tsort</span><span class="p">(</span><span class="n">each_node</span><span class="p">,</span> <span class="n">each_child</span><span class="p">)</span>

<span class="nb">puts</span>

<span class="no">TSort</span><span class="p">.</span><span class="nf">each_strongly_connected_component_from</span><span class="p">(</span><span class="ss">:five</span><span class="p">,</span> <span class="n">each_child</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">scc</span><span class="o">|</span>
  <span class="nb">method</span><span class="p">(</span><span class="n">scc</span><span class="p">.</span><span class="nf">first</span><span class="p">).</span><span class="nf">call</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>In the example, the TASKS hash constant defines the list of tasks that needs to be
completed. The key refers to the task name and its value is a list of dependent
tasks that needs to be completed before it can run.</p>

<p>For example, TASKS[:one] is an empty array which means it has no dependencies
and can be run first. TASKS[:four] is dependent on the completion of tasks :one
and :three. Each hash key is a symbol which corresponds to a local method.</p>

<p>We require ‘tsort’. Then we invoke the module method <a href="http://www.ruby-doc.org/stdlib-2.1.2/libdoc/tsort/rdoc/TSort.html#method-c-each_strongly_connected_component_from" target="_blank">each_strongly_connected_component_from</a>, which takes two arguments:
the starting node, which in this case, is the task :five from the TASKS hash.</p>

<p>The second argument must be an object which responds to call. ‘each_child’ is a method object
which references the ‘dependent_tasks’ method. The dependent_tasks method yields
the children of each node into a block which is processed by TSort.</p>

<p><a href="http://www.ruby-doc.org/stdlib-2.1.2/libdoc/tsort/rdoc/TSort.html#method-i-tsort" target="_blank">tsort</a> returns a list of sorted nodes from children to parents.</p>

<p>If we run the above script, this is the output we see, with task :five set as the default:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="no">Running</span> <span class="n">tasks</span> <span class="k">in</span> <span class="n">the</span> <span class="n">following</span> <span class="ss">order:
</span><span class="n">one</span>
<span class="n">three</span>
<span class="n">four</span>
<span class="n">two</span>
<span class="n">five</span>

<span class="no">Task</span> <span class="n">one</span> <span class="n">ran!</span>
<span class="n">date</span> <span class="s1">'+TASK 1 DATE: %m/%d/%y%nTASK 1 TIME:%H:%M:%S'</span> <span class="o">&gt;</span> <span class="n">t1</span>

<span class="no">Task</span> <span class="n">three</span> <span class="n">ran!</span>
<span class="n">date</span> <span class="s1">'+TASK 3 DATE: %m/%d/%y%nTASK 3 TIME:%H:%M:%S'</span> <span class="o">&gt;</span> <span class="n">t3</span>

<span class="no">Task</span> <span class="n">four</span> <span class="n">ran!</span>
<span class="n">cat</span> <span class="n">t1</span> <span class="n">t3</span> <span class="o">&gt;</span> <span class="n">t4</span>

<span class="no">Task</span> <span class="n">two</span> <span class="n">ran!</span>
<span class="n">date</span> <span class="s1">'+TASK 2 DATE: %m/%d/%y%nTASK 2 TIME:%H:%M:%S'</span> <span class="o">&gt;</span> <span class="n">t2</span>

<span class="no">Task</span> <span class="n">five</span> <span class="n">ran!</span>
<span class="n">cat</span> <span class="n">t4</span> <span class="n">t2</span> <span class="o">&gt;</span> <span class="n">t5</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>From the output, TSort sees that TASK[:five] is dependent on tasks :four and :two.
Task :four has two children: tasks :one and three. Hence, tasks :one and :three
are executed first, followed by task :four. It proceeds to run task :two and since
it has no child nodes, task :five is then run.</p>

<p>If any of the tasks encounter an exception, execution stops at that point
and no further tasks are run. For example, if an error is raised in task one method
call:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">one</span>
  <span class="nb">puts</span> <span class="s2">"Task one ran!"</span>
  <span class="k">raise</span> <span class="s2">"Error!"</span>
  <span class="n">command</span> <span class="s2">"date '+TASK 1 DATE: %m/%d/%y%nTASK 1 TIME:%H:%M:%S' &gt; t1"</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>none of the other tasks are executed:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="no">Task</span> <span class="n">one</span> <span class="n">ran!</span>
<span class="n">tasks</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">13</span><span class="ss">:in</span> <span class="sb">`one': Error! (RuntimeError)
  from tasks.rb:62:in `</span><span class="n">call</span><span class="s1">'
  from tasks.rb:62:in `block in &lt;main&gt;'</span>
  <span class="n">from</span> <span class="sr">/Users/</span><span class="n">chee</span><span class="o">/</span><span class="p">.</span><span class="nf">rvm</span><span class="o">/</span><span class="n">rubies</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tsort</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">420</span><span class="ss">:in</span> <span class="sb">`block (2 levels) in each_strongly_connected_component_from'
  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:420:in `</span><span class="n">block</span> <span class="p">(</span><span class="mi">2</span> <span class="n">levels</span><span class="p">)</span> <span class="k">in</span> <span class="n">each_strongly_connected_component_from</span><span class="s1">'
  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:429:in `each_strongly_connected_component_from'</span>
  <span class="n">from</span> <span class="sr">/Users/</span><span class="n">chee</span><span class="o">/</span><span class="p">.</span><span class="nf">rvm</span><span class="o">/</span><span class="n">rubies</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tsort</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">419</span><span class="ss">:in</span> <span class="sb">`block in each_strongly_connected_component_from'
  from tasks.rb:53:in `</span><span class="n">each</span><span class="s1">'
  from tasks.rb:53:in `dependent_tasks'</span>
  <span class="n">from</span> <span class="sr">/Users/</span><span class="n">chee</span><span class="o">/</span><span class="p">.</span><span class="nf">rvm</span><span class="o">/</span><span class="n">rubies</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tsort</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">413</span><span class="ss">:in</span> <span class="sb">`call'
  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:413:in `</span><span class="n">each_strongly_connected_component_from</span><span class="s1">'
  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:419:in `block in each_strongly_connected_component_from'</span>
  <span class="n">from</span> <span class="n">tasks</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">53</span><span class="ss">:in</span> <span class="sb">`each'
  from tasks.rb:53:in `</span><span class="n">dependent_tasks</span><span class="s1">'
  from /Users/chee/.rvm/rubies/ruby-2.2.0/lib/ruby/2.2.0/tsort.rb:413:in `call'</span>
  <span class="n">from</span> <span class="sr">/Users/</span><span class="n">chee</span><span class="o">/</span><span class="p">.</span><span class="nf">rvm</span><span class="o">/</span><span class="n">rubies</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tsort</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">413</span><span class="ss">:in</span> <span class="sb">`each_strongly_connected_component_from'
  from tasks.rb:61:in `</span><span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span><span class="err">'</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Although one could have structured the above using just arrays, TSort automatically
works out where it should start from, rather than having to work it out manually.</p>

</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:f/mnqwaypk"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2022 Chee Yeo<br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>




  
    <script src="//localhost:35729/livereload.js" async></script>
  

  <script src="/assets/site.min-fc110d15723a68aba602939bc68958f7.js" type="text/javascript" async></script>
</body>
</html>
