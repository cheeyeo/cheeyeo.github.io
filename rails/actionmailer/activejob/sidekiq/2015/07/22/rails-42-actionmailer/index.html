<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Rails 4.2 ActionMailer &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Using ActionMailer in Rails 4.2 wth sidekiq">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="actionmailer, activejob, rails, sidekiq">
    <link rel="canonical" href="https://cheeyeo.uk/rails/actionmailer/activejob/sidekiq/2015/07/22/rails-42-actionmailer/">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Lato:900,300|Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/assets/global-ef3d2a30bafae51bdca9401db921816a.css" type="text/css">

    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <script src="/assets/modernizr.custom-d69c837039e5f58032e4842950ab13c3.js" async></script>

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Rails 4.2 ActionMailer">
    <meta property="og:description" content="Chee Yeo is a machine learning developer and AWS Solutions Architect Associate from the UK.">
    <meta property="og:url" content="/rails/actionmailer/activejob/sidekiq/2015/07/22/rails-42-actionmailer/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Rails 4.2 ActionMailer</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">July 22, 2015</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/actionmailer">actionmailer</a>
      </li>
      
      <li>
        <a href="/categories/activejob">activejob</a>
      </li>
      
      <li>
        <a href="/categories/rails">rails</a>
      </li>
      
      <li>
        <a href="/categories/sidekiq">sidekiq</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p>From Rails 4.2, you can deliver an email asynchronously using ActiveJob which is built into ActionMailer.</p>

<p>ActionMailer now comes with two additional methods:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1</span> <span class="n">deliver_later</span>
<span class="lineno">2</span> <span class="n">deliver_now</span></code></pre></div>

<p><strong>deliver_now</strong> is similar to the original deliver method; it sends the email synchronously.</p>

<p><strong>deliver_later</strong> makes use of your background job system to send the email.</p>

<p>Note that there is a difference between the bang and non-bang methods.</p>

<p>With deliver_later! and its bang methods, no exceptions will be raised if an error occurs when sending the mail. Without the bang methods, exceptions will be raised if the mail fails to send.</p>

<p>To get this to work properly, some additional changes need to be made.</p>

<p>Firstly, make sure that your background job system is setup and working properly. We are using Sidekiq for this example.</p>

<p>This assumes that you have <strong>config.active_job.queue_adapter</strong> set like so:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1</span> <span class="c1"># within config/application.rb</span>
<span class="lineno">2</span> 
<span class="lineno">3</span> <span class="n">config</span><span class="o">.</span><span class="n">active_job</span><span class="o">.</span><span class="n">queue_adapter</span> <span class="o">=</span> <span class="ss">:sidekiq</span></code></pre></div>

<p>Next you need to add the <strong>‘mailers’</strong> queue into the config file. ActionMailer by default places background deliveries into this queue.</p>

<p>For sidekiq:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1</span> <span class="c1"># config/sidekiq.yml</span>
<span class="lineno">2</span> 
<span class="lineno">3</span> <span class="ss">:queues</span><span class="p">:</span>
<span class="lineno">4</span>   <span class="o">-</span> <span class="o">[</span><span class="n">mailers</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span></code></pre></div>

<p>Create a mailer and call deliver_later and if it all goes well you should see the below in your log file:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1</span> <span class="o">[</span><span class="no">ActiveJob</span><span class="o">]</span> <span class="o">[</span><span class="no">ActionMailer</span><span class="o">::</span><span class="no">DeliveryJob</span><span class="o">]</span> <span class="o">[</span><span class="n">fd25b472</span><span class="o">-</span><span class="mi">9</span><span class="n">d80</span><span class="o">-</span><span class="mi">47</span><span class="n">f2</span><span class="o">-</span><span class="mi">9</span><span class="n">ea6</span><span class="o">-</span><span class="mi">5</span><span class="n">da0e3cf7552</span><span class="o">]</span> <span class="no">Performed</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">DeliveryJob</span> <span class="n">from</span> <span class="no">Sidekiq</span><span class="p">(</span><span class="n">mailers</span><span class="p">)</span> <span class="k">in</span> <span class="mi">3160</span><span class="o">.</span><span class="mi">77</span><span class="n">ms</span></code></pre></div>

<h1 id="tracking-exceptions">Tracking exceptions</h1>

<p>It is inevitable that errors might occur in your mailers. When using sidekiq, it has a default mechanism for queuing and retrying failed jobs. If an exception occurs in your mailer when sending asynchronously, it will be placed into this queue and retried for at least 25 times as a default.</p>

<p>To be notified of when an exception occurs, we can hook into sidekiq eror handlers like so:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="c1"># config/initializers/sidekiq.rb</span>
<span class="lineno"> 2</span> <span class="no">Sidekiq</span><span class="o">.</span><span class="n">configure_server</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="lineno"> 3</span>   <span class="n">config</span><span class="o">.</span><span class="n">error_handlers</span> <span class="o">&lt;&lt;</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">ex</span><span class="p">,</span><span class="n">ctx_hash</span><span class="o">|</span>
<span class="lineno"> 4</span>     <span class="no">SidekiqError</span><span class="o">.</span><span class="n">log_exception</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ctx_hash</span><span class="p">)</span>
<span class="lineno"> 5</span>   <span class="p">}</span>
<span class="lineno"> 6</span> <span class="k">end</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="c1"># sidekiq_error.rb</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="k">class</span> <span class="nc">SidekiqError</span>
<span class="lineno">11</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">logger</span>
<span class="lineno">12</span>     <span class="vi">@logger</span> <span class="o">||=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/log/sidekiq.log&quot;</span><span class="p">)</span>
<span class="lineno">13</span>   <span class="k">end</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">log_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{})</span>
<span class="lineno">16</span>     <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="s2">&quot;Error class: </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="s2">&quot;error_class&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">17</span>     <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="s2">&quot;Error message: </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="s2">&quot;error_message&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">18</span>     <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
<span class="lineno">19</span>     <span class="n">st</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>     <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="n">st</span>
<span class="lineno">22</span>     <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="s2">&quot;Failed At: </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="s2">&quot;failed_at&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">23</span>     <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="s2">&quot;Retry Count: </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="s2">&quot;retry_count&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">24</span>     <span class="nb">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="s2">&quot;Retried At: </span><span class="si">#{</span><span class="n">args</span><span class="o">[</span><span class="s2">&quot;retried_at&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">25</span>   <span class="k">end</span>
<span class="lineno">26</span> <span class="k">end</span></code></pre></div>

<p>I still have not worked out a way to rescue exceptions within async mailers as the class is defined automatically in ActionMailer when you call deliver_later from your mailer:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="c1"># actionmailer/lib/action_mailer/delivery_job.rb</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="nb">require</span> <span class="s1">&#39;active_job&#39;</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="k">module</span> <span class="nn">ActionMailer</span>
<span class="lineno"> 6</span>   <span class="c1"># The &lt;tt&gt;ActionMailer::DeliveryJob&lt;/tt&gt; class is used when you</span>
<span class="lineno"> 7</span>   <span class="c1"># want to send emails outside of the request-response cycle.</span>
<span class="lineno"> 8</span>   <span class="k">class</span> <span class="nc">DeliveryJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span> <span class="c1"># :nodoc:</span>
<span class="lineno"> 9</span>     <span class="n">queue_as</span> <span class="p">{</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliver_later_queue_name</span> <span class="p">}</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">mailer</span><span class="p">,</span> <span class="n">mail_method</span><span class="p">,</span> <span class="n">delivery_method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
<span class="lineno">12</span>       <span class="n">mailer</span><span class="o">.</span><span class="n">constantize</span><span class="o">.</span><span class="n">public_send</span><span class="p">(</span><span class="n">mail_method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">delivery_method</span><span class="p">)</span>
<span class="lineno">13</span>     <span class="k">end</span>
<span class="lineno">14</span>   <span class="k">end</span>
<span class="lineno">15</span> <span class="k">end</span></code></pre></div>

<p>One approach would be to create a refinement for ActionMailer::MessageDelivery enqueue_delivery private method to use a custom ActiveJob object which has a rescue_from block but that is the topic of another blog post.</p>

<p>Happy Hacking!</p>

</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="https://cheeyeo.uk/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:ckyeo.1@gmail.com"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2021 Chee Yeo<br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>




  

  <script src="/assets/site.min-fc110d15723a68aba602939bc68958f7.js" type="text/javascript" async></script>
</body>
</html>
