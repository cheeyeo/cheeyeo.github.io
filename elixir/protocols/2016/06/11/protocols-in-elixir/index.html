<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Elixir Protocols &#8211; Blog of software writer Chee Yeo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="What are protocols in Elixir and how are they useful">
    <meta name="author" content="Chee Yeo">
    <meta name="keywords" content="elixir, protocols">
    <link rel="canonical" href="https://www.cheeyeo.dev/elixir/protocols/2016/06/11/protocols-in-elixir/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Blog of software writer Chee Yeo" href="/feed.xml" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202302141635" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_UK">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Elixir Protocols">
    <meta property="og:description" content="Chee Yeo is a software developer with interests in machine learning and cloud computing.">
    <meta property="og:url" content="https://www.cheeyeo.dev/elixir/protocols/2016/06/11/protocols-in-elixir/">
    <meta property="og:site_name" content="Blog of software writer Chee Yeo">
</head>

<body class="">
  <div class="color-line"></div>
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="https://tilrnt.github.io/" target="_blank">TILRNT</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
        </nav>
      
      <div class="clearfix"></div>
    </div>
  </div>
</header>

    <header class="blog-header">
  <h1 class="blog-title">Elixir Protocols</h1>

  
  <div class="meta_info">
    
    <div class="author-date-wrap">
      <div class="author">
        <a href="/about">Chee Yeo</a>
      </div>
    </div>
    
    <span class="post-date">June 11, 2016</span>
    
    <ul class="article-tag">
      
      <li>
        <a href="/categories/elixir">elixir</a>
      </li>
      
      <li>
        <a href="/categories/protocols">protocols</a>
      </li>
      
    </ul>
    
  </div>
  
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<article class="post-content top-border">
  <p>Protocols are a powerful language feature in Elixir. It allows you to specify an api which should be defined by its implementation. If you ever need to create functions that accept polymorphic types, protocols allow you to do so in a managed and organized manner.</p>

<p>Although Elixir Behaviours are similar, Behaviours are defined internally within each module. Protocol implementations can occur externally outside of the module. This allows for extending a module’s functionality you don’t have access to.</p>

<p>Suppose we created an Odd protocol which returns true or false depending on the type.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="k">defprotocol</span> <span class="no">Odd</span> <span class="k">do</span>
  <span class="nv">@doc</span> <span class="s2">"Returns true if the data is considered odd"</span>
  <span class="nv">@fallback_to_any</span> <span class="no">true</span>

  <span class="k">def</span> <span class="n">odd?</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">@doc</code> describes what the protocol does. The function to be implemented is <code class="language-plaintext highlighter-rouge">def odd?(data)</code>. <code class="language-plaintext highlighter-rouge">@fallback_to_any</code> is an attribute which specifies that a default implementation of <code class="language-plaintext highlighter-rouge">Any</code> is to be used in the event that no specific implementation of Odd is found for that particular type.</p>

<p>To implement the protocol:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="k">defimpl</span> <span class="no">Odd</span><span class="p">,</span> <span class="ss">for:</span> <span class="no">Integer</span> <span class="k">do</span>
  <span class="kn">require</span> <span class="no">Integer</span>

  <span class="k">def</span> <span class="n">odd?</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Integer</span><span class="o">.</span><span class="n">is_odd</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">defimpl</span> <span class="no">Odd</span><span class="p">,</span> <span class="ss">for:</span> <span class="no">Float</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">odd?</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(</span><span class="n">trunc</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">defimpl</span> <span class="no">Odd</span><span class="p">,</span> <span class="ss">for:</span> <span class="no">List</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">odd?</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(</span><span class="no">Enum</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">defimpl</span> <span class="no">Odd</span><span class="p">,</span> <span class="ss">for:</span> <span class="no">Any</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">odd?</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">false</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">defimpl</code> defines the Odd protocol for the type specified in <code class="language-plaintext highlighter-rouge">for</code> in this case for both Integer and Float types.</p>

<p>We define an integer as odd if <code class="language-plaintext highlighter-rouge">Integer.is_odd</code> macro returns true although we can also write our own implementation here.</p>

<p>For a float, we define it as odd if the integer part of the float is odd. Since <code class="language-plaintext highlighter-rouge">trunc</code> returns an integer, we can pass it to the earlier implementation of odd for Integer through <code class="language-plaintext highlighter-rouge">Odd.odd?</code></p>

<p>For lists, it is odd if it has an odd number of elements.</p>

<p>The final implementation is a default fallback for any data type for which there is no odd protocol implementation. This is required by the <code class="language-plaintext highlighter-rouge">@fallback_to_any</code> attribute else it will not compile.</p>

<p>Now we can call it like so:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># true</span>

<span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># false</span>

<span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(</span><span class="mf">1.9</span><span class="p">)</span> <span class="c1"># true</span>

<span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(</span><span class="mf">2.1</span><span class="p">)</span> <span class="c1"># false</span>

<span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># true</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>To test the implementation directly:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="no">Odd</span><span class="o">.</span><span class="no">Integer</span><span class="o">.</span><span class="n">odd?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># true</span>

<span class="no">Odd</span><span class="o">.</span><span class="no">Float</span><span class="o">.</span><span class="n">odd?</span><span class="p">(</span><span class="mf">1.9</span><span class="p">)</span> <span class="c1"># true</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>For data types which don’t implement Odd it will automatically trigger the <code class="language-plaintext highlighter-rouge">Any</code> implementation of protocol which always returns false:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(%{})</span> <span class="c1"># false</span>

<span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(</span><span class="ss">:atom</span><span class="p">)</span> <span class="c1"># false</span>

<span class="no">Odd</span><span class="o">.</span><span class="n">impl_for</span><span class="p">(%{})</span> <span class="c1"># Odd.Any</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We can also define protocols for user defined data types such as structs.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="c1"># assuming we created an Animal struct</span>

<span class="k">defmodule</span> <span class="no">Animal</span> <span class="k">do</span>
  <span class="k">defstruct</span> <span class="p">[</span><span class="ss">:hairy</span><span class="p">]</span>
<span class="k">end</span>

<span class="k">defimpl</span> <span class="no">Odd</span><span class="p">,</span> <span class="ss">for:</span> <span class="no">Animal</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">odd?</span><span class="p">(%</span><span class="no">Animal</span><span class="p">{</span><span class="ss">hairy:</span> <span class="no">true</span><span class="p">}),</span> <span class="k">do</span><span class="p">:</span> <span class="no">true</span>
  <span class="k">def</span> <span class="n">odd?</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">false</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Here, we define an Animal to be odd if it is hairy.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(%</span><span class="no">Animal</span><span class="p">{</span><span class="ss">hairy:</span> <span class="no">true</span><span class="p">})</span> <span class="c1"># true</span>

<span class="no">Odd</span><span class="o">.</span><span class="n">odd?</span><span class="p">(%</span><span class="no">Animal</span><span class="p">{</span><span class="ss">hairy:</span> <span class="no">false</span><span class="p">})</span> <span class="c1"># false</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>There are 2 useful introspection functions for protocols which I find useful:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">__protocol__(:functions)</code></p>

    <p>List all functions and their arity as defined by the protocol</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">impl_for(structure)</code></p>

    <p>Returns module which implements protocol for that structure.</p>
  </li>
</ul>

<p>Example usage:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="no">Odd</span><span class="o">.</span><span class="n">__protocol__</span><span class="p">(</span><span class="ss">:functions</span><span class="p">)</span> <span class="c1">#=&gt; [:odd]</span>

<span class="no">Odd</span><span class="o">.</span><span class="n">impl_for</span><span class="p">(%</span><span class="no">Animal</span><span class="p">{})</span> <span class="c1">#=&gt; Odd.Animal</span>

<span class="no">Odd</span><span class="o">.</span><span class="n">impl_for</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#=&gt; Odd.Integer</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="redefining-an-existing-module-behaviour">Redefining an existing module behaviour</h3>

<p>Lets assume we want to redefine the print format of Animal struct. <code class="language-plaintext highlighter-rouge">inspect</code> calls <code class="language-plaintext highlighter-rouge">Inspect.inspect</code> and <code class="language-plaintext highlighter-rouge">Inspect</code> is a protocol. We can redefine it like so:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="k">defimpl</span> <span class="no">Inspect</span><span class="p">,</span> <span class="ss">for:</span> <span class="no">Animal</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">inspect</span><span class="p">(</span><span class="n">animal</span><span class="p">,</span> <span class="n">_opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># convert animal struct to map to get the attributes:</span>
    <span class="n">attr_str</span> <span class="o">=</span> <span class="no">Map</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">animal</span><span class="p">,</span> <span class="ss">:__struct__</span><span class="p">)</span>
               <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="k">fn</span><span class="p">({</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">},</span> <span class="n">acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">acc</span> <span class="o">&lt;&gt;</span> <span class="s2">"* </span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2">"</span> <span class="k">end</span><span class="p">)</span>

    <span class="sd">"""
    Animal has the following attrs:

    #{attr_str}
    """</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now when we call <code class="language-plaintext highlighter-rouge">inspect</code> on an Animal struct, we get the following:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="no">IO</span><span class="o">.</span><span class="n">inspect</span> <span class="p">%</span><span class="no">Animal</span><span class="p">{</span><span class="ss">hairy:</span> <span class="no">false</span><span class="p">}</span>

<span class="c1"># =&gt; Animal has the following attrs:</span>
<span class="c1"># * hairy -&gt; false</span>

<span class="c1"># to ensure IO.inspect is calling Inspect.Animal</span>
<span class="no">Inspect</span><span class="o">.</span><span class="n">impl_for</span><span class="p">(%</span><span class="no">Animal</span><span class="p">{})</span> <span class="c1"># =&gt; Inspect.Animal</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="summary">Summary</h3>

<p>Protocols are a powerful feature to help support polymorphism in Elixir. We have seen how to define our custom protocol for standard system types as well as for our own structs. We have also seen a trivial example of how to redefine a system built protocol for our own ends.</p>

<p>A <a href="https://github.com/cheeyeo/Elixir-Protocol" target="_blank">sample github repository</a> for this post is available.</p>

<p>Keep hacking and stay curious!!</p>

<h3 id="further-information">Further information</h3>

<ul>
  <li><a href="http://elixir-lang.org/getting-started/protocols.html" target="_blank">Elixir Getting Started guide on protocols</a></li>
  <li><a href="http://elixir-lang.org/docs/stable/elixir/Kernel.html#defprotocol/" target="_blank">defprotocol documentation</a></li>
  <li><a href="http://elixir-lang.org/docs/stable/elixir/Protocol.html" target="_blank">Functions for working with Protocol</a></li>
</ul>


</article>





      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    
      <div class="social-icons">
  <div class="">
    
      <a class="fa fa-github fa-lg" href="https://github.com/cheeyeo" target="_blank"></a>
    
    <a class="fa fa-rss fa-lg" href="https://www.cheeyeo.dev/feed.xml" target="_blank"></a>
    
    
    
      <a class="fa fa-envelope fa-lg" href="mailto:f/mnqwaypk"></a>
    
    
      <a class="fa fa-linkedin fa-lg" href="https://www.linkedin.com/in/cheeyeo" target="_blank"></a>
    
  </div>
</div>

    

    <div class="measure mt1 center">
      <strong>© 2023 Chee Yeo</strong><br/>
      <small>
        Built using the Pixll theme available on <a href="https://github.com/johno/pixyll" target="_blank">Github</a>.
      </small>
    </div>
  </div>
</footer>



</body>
</html>
